<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ringvox Outreach Dashboard</title>
    <link rel="icon" href="https://ringvox.co/images/brand/favicon-32.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f13;
            color: #e5e5e5;
            min-height: 100vh;
        }

        /* ── Header ── */
        .header {
            background: linear-gradient(135deg, #18181b 0%, #1a1520 50%, #18181b 100%);
            border-bottom: 1px solid rgba(249,115,22,0.15);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 200;
            backdrop-filter: blur(12px);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-area svg { flex-shrink: 0; }
        .logo-text {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #fb923c, #f97316, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        .logo-tagline {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .header-divider {
            width: 1px;
            height: 32px;
            background: rgba(255,255,255,0.08);
        }
        .page-title {
            font-size: 15px;
            font-weight: 600;
            color: #d1d5db;
        }
        .page-title span {
            color: #f97316;
        }

        /* ── Stats bar ── */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .stat-pill .num {
            font-size: 18px;
            font-weight: 800;
        }
        .stat-sent .num { color: #22c55e; }
        .stat-total .num { color: #f97316; }
        .sync-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .sync-ok { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
        .sync-err { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
        .sync-loading { background: #f97316; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .sync-label { font-size: 10px; color: #6b7280; }

        /* ── Main content ── */
        .main {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ── Controls row ── */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 14px 8px 36px;
            background: #1e1e24;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-box:focus { border-color: #f97316; }
        .search-box::placeholder { color: #555; }
        .search-wrap {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        .search-wrap svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #555;
        }

        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid #2a2a32;
            background: #1e1e24;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.2s;
            font-family: inherit;
        }
        .filter-btn.active {
            border-color: #f97316;
            background: rgba(249,115,22,0.1);
            color: #f97316;
        }
        .filter-btn:hover { border-color: #f97316; color: #d1d5db; }

        /* ── Batch headers ── */
        .batch-header {
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            margin: 24px 0 8px 0;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.3px;
            position: sticky;
            top: 57px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .batch-header svg { opacity: 0.7; }

        /* ── Contact cards ── */
        .contact {
            background: #1a1a22;
            border: 1px solid #2a2a32;
            padding: 14px 16px;
            margin: 6px 0;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .contact:hover { border-color: #3a3a44; }
        .contact.sent {
            opacity: 0.35;
            border-color: #1e1e24;
        }
        .contact.sent .whatsapp-btn { background: #333; pointer-events: none; }
        .contact-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sent-check {
            width: 18px; height: 18px;
            cursor: pointer;
            accent-color: #22c55e;
            flex-shrink: 0;
        }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name {
            font-weight: 600;
            font-size: 14px;
            color: #f3f4f6;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .contact-name strong { color: #fb923c; font-weight: 700; }
        .contact-details {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .contact-details a {
            color: #60a5fa;
            text-decoration: none;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        .contact-details a:hover { text-decoration: underline; color: #93bbfc; }

        .trade-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trade-Plumber { background: rgba(37,99,235,0.15); color: #60a5fa; }
        .trade-Electrician { background: rgba(249,115,22,0.15); color: #fb923c; }
        .trade-Builder { background: rgba(34,197,94,0.15); color: #4ade80; }

        .contact-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }
        .whatsapp-btn:hover { background: #20BA5A; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,211,102,0.3); }
        .edit-btn {
            background: transparent;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            padding: 7px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s;
            line-height: 1;
        }
        .edit-btn:hover { border-color: #f97316; color: #f97316; }
        .edit-btn.active { border-color: #f97316; color: #f97316; background: rgba(249,115,22,0.08); }

        /* ── Message editor ── */
        .message-editor {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2a2a32;
        }
        .message-editor.open { display: block; }
        .message-editor textarea {
            width: 100%;
            min-height: 180px;
            padding: 12px;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            color: #e5e5e5;
            background: #12121a;
            outline: none;
            transition: border-color 0.2s;
        }
        .message-editor textarea:focus { border-color: #f97316; }
        .editor-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }
        .editor-actions small { color: #6b7280; font-size: 11px; }
        .editor-actions small.custom { color: #f97316; }
        .reset-msg-btn {
            font-size: 11px;
            color: #6b7280;
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            font-family: inherit;
        }
        .reset-msg-btn:hover { color: #ef4444; }

        /* ── Reset button ── */
        .reset-all-btn {
            font-size: 10px;
            color: #4b5563;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .reset-all-btn:hover { color: #ef4444; }

        /* ── Responsive ── */
        @media (max-width: 640px) {
            .header { flex-direction: column; gap: 10px; padding: 12px 16px; }
            .stats-bar { width: 100%; justify-content: center; }
            .header-divider { display: none; }
            .main { padding: 12px; }
            .contact-row { flex-wrap: wrap; }
            .contact-actions { width: 100%; justify-content: flex-end; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <!-- ── Header ── -->
    <div class="header">
        <div class="header-left">
            <div class="logo-area">
                <svg width="36" height="36" viewBox="0 0 48 48" fill="none">
                    <defs>
                        <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#f97316"/>
                            <stop offset="50%" stop-color="#f45d2b"/>
                            <stop offset="100%" stop-color="#d946a8"/>
                        </linearGradient>
                    </defs>
                    <rect x="4" y="18" width="5.5" height="16" rx="2.75" fill="url(#bg)"/>
                    <rect x="13" y="10" width="5.5" height="30" rx="2.75" fill="url(#bg)"/>
                    <rect x="22" y="3" width="5.5" height="42" rx="2.75" fill="url(#bg)"/>
                    <rect x="31" y="13" width="5.5" height="26" rx="2.75" fill="url(#bg)"/>
                    <rect x="40" y="20" width="5.5" height="12" rx="2.75" fill="url(#bg)"/>
                    <path d="M35 6 L36.2 9 L39.2 10.2 L36.2 11.4 L35 14.4 L33.8 11.4 L30.8 10.2 L33.8 9 Z" fill="#f97316" opacity="0.9"/>
                    <path d="M42.5 15 L43.1 16.2 L44.5 16.8 L43.1 17.4 L42.5 18.6 L41.9 17.4 L40.5 16.8 L41.9 16.2 Z" fill="#fdba74" opacity="0.6"/>
                </svg>
                <div>
                    <div class="logo-text">Ringvox</div>
                    <div class="logo-tagline">AI Voice Agents. Always On.</div>
                </div>
            </div>
            <div class="header-divider"></div>
            <div class="page-title"><span>WhatsApp</span> Outreach</div>
        </div>
        <div class="stats-bar">
            <div class="stat-pill stat-sent">
                <span class="num" id="sent-count">0</span>
                <span>sent</span>
            </div>
            <div class="stat-pill stat-total">
                <span class="num" id="total-shown">100</span>
                <span>contacts</span>
            </div>
            <div style="display:flex;align-items:center;gap:5px;">
                <span class="sync-dot sync-loading" id="sync-dot"></span>
                <span class="sync-label" id="sync-label">syncing</span>
            </div>
            <button class="reset-all-btn" onclick="resetAll()">reset all</button>
        </div>
    </div>

    <!-- ── Main ── -->
    <div class="main">
        <div class="controls">
            <div class="search-wrap">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input type="text" class="search-box" id="search" placeholder="Search by name, city, or phone...">
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="Plumber">Plumbers</button>
                <button class="filter-btn" data-filter="Electrician">Electricians</button>
                <button class="filter-btn" data-filter="Builder">Builders</button>
            </div>
        </div>

        <div id="contacts-container"></div>
    </div>

    <script>
    // ── Supabase ──
    const SB_URL = 'https://nantnllmvftqmrwjorqe.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbnRubGxtdmZ0cW1yd2pvcnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzQyOTYsImV4cCI6MjA4NjkxMDI5Nn0.os0CptUMkUxRXLm3_EsJq9GimwGKtUSNZ9hiQ7cLNsU';

    async function sbFetch(path, opts = {}) {
      const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
        ...opts,
        headers: {
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation',
          ...(opts.headers || {})
        }
      });
      if (!res.ok) throw new Error(`Supabase ${res.status}`);
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    // ── Contacts ──
    const contacts = [
      {name:"Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871660582",dp:"0871660582",fn:"",web:"https://aturnerplumbing.ie/"},
      {name:"Pat Kelleher Plumbing",trade:"Plumber",city:"Cork",phone:"353879730364",dp:"0879730364",fn:"Pat",web:"https://www.kelleherplumbing.ie/"},
      {name:"Emergency Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871345062",dp:"0871345062",fn:"",web:"https://gaselectricalservices.ie/emergency-call-out/"},
      {name:"Tony Leahy Heating & Plumbing",trade:"Plumber",city:"Cork",phone:"353879223332",dp:"0879223332",fn:"Tony",web:"http://www.tonyleahyheatingandplumbingservices.ie/"},
      {name:"Plumbing Maintenance and Call",trade:"Plumber",city:"Cork",phone:"353879470505",dp:"0879470505",fn:"",web:"https://crowleyplumbing.ie/plumbing-services/plumbing-maintenance-and-call-outs/"},
      {name:"Cork Enterprise Plumbing",trade:"Plumber",city:"Cork",phone:"353878507445",dp:"0878507445",fn:"",web:"https://www.corkenterpriseplumbing.com/"},
      {name:"Plumbers Cork County",trade:"Plumber",city:"Cork",phone:"353873955256",dp:"0873955256",fn:"",web:"https://www.goldenpages.ie/plumbers/cork-county/"},
      {name:"Cork Electrician",trade:"Electrician",city:"Cork",phone:"353868131570",dp:"0868131570",fn:"",web:"https://corkelectricianslimited.ie/"},
      {name:"Electricians Cork County",trade:"Electrician",city:"Cork",phone:"353862538477",dp:"0862538477",fn:"",web:"https://www.goldenpages.ie/electricians/cork-county/"},
      {name:"Electrician Cork",trade:"Electrician",city:"Cork",phone:"353877464011",dp:"0877464011",fn:"",web:"https://corkelectrical.ie/"},
      {name:"Electricians in Cork",trade:"Electrician",city:"Cork",phone:"353862563322",dp:"0862563322",fn:"",web:"https://www.hotfrog.ie/find/electricians/cork"},
      {name:"Small Builders Cork",trade:"Builder",city:"Cork",phone:"353874656330",dp:"0874656330",fn:"",web:"https://www.forgedconstruction.ie/"},
      {name:"Chris O'Donovan Construction",trade:"Builder",city:"Cork",phone:"353872335198",dp:"0872335198",fn:"Chris",web:"http://chrisodonovanconstruction.com/"},
      {name:"Builder Cork",trade:"Builder",city:"Cork",phone:"353872925951",dp:"0872925951",fn:"",web:"https://murtyosullivanbuilders.ie/"},
      {name:"Builders in Cork",trade:"Builder",city:"Cork",phone:"353872360514",dp:"+353872360514",fn:"",web:"https://www.constructionireland.ie/d_s/1,-1/cork/builders"},
      {name:"DKS Construction",trade:"Builder",city:"Cork",phone:"353876807226",dp:"0876807226",fn:"",web:"https://www.dksconstruction.ie/"},
      {name:"Building Contractors Cork",trade:"Builder",city:"Cork",phone:"353214859032",dp:"0214859032",fn:"",web:"https://chamber.corkchamber.ie/list/category/building-contractors-providers-10"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863579495",dp:"0863579495",fn:"",web:"https://plumber-dublin.ie/"},
      {name:"24 Hour Plumber",trade:"Plumber",city:"Dublin",phone:"353858556111",dp:"0858556111",fn:"",web:"https://www.24hourplumber.ie"},
      {name:"Plumbers Dublin County",trade:"Plumber",city:"Dublin",phone:"353862345954",dp:"0862345954",fn:"",web:"https://www.goldenpages.ie/plumbers/dublin-dublin-county/"},
      {name:"The Dublin Plumber",trade:"Plumber",city:"Dublin",phone:"353858667631",dp:"0858667631",fn:"",web:"https://www.thedublinplumber.ie/"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863748000",dp:"0863748000",fn:"",web:"https://dublinplumber24hrs.ie/"},
      {name:"Plumber Dublin 24/7",trade:"Plumber",city:"Dublin",phone:"35314851554",dp:"014851554",fn:"",web:"https://plumbers247.net/"},
      {name:"Plumber Dublin 12",trade:"Plumber",city:"Dublin",phone:"35315143300",dp:"015143300",fn:"",web:"https://www.dewarplumbers.ie/plumber-dublin-12.html"},
      {name:"Kieron Murphy Plumbing",trade:"Plumber",city:"Dublin",phone:"353872768007",dp:"0872768007",fn:"Kieron",web:"https://plumbingheating.ie/"},
      {name:"RapidPlumb",trade:"Plumber",city:"Dublin",phone:"353851054991",dp:"0851054991",fn:"",web:"https://www.rapidplumb.ie/"},
      {name:"Emergency Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353866049361",dp:"0866049361",fn:"",web:"https://www.sidsplumbing.ie/"},
      {name:"Dublin Plumbing",trade:"Plumber",city:"Dublin",phone:"35315354268",dp:"015354268",fn:"",web:"https://dublinplumbing.ie/contact-us/"},
      {name:"House Rewire Dublin",trade:"Electrician",city:"Dublin",phone:"353858238132",dp:"0858238132",fn:"",web:"https://dublin-electricians.ie/"},
      {name:"Mobile Auto Electrician Dublin",trade:"Electrician",city:"Dublin",phone:"353852332555",dp:"0852332555",fn:"",web:"https://www.mobileautoelectrician.ie/"},
      {name:"Clontarf Electrician",trade:"Electrician",city:"Dublin",phone:"353862525331",dp:"0862525331",fn:"",web:"https://www.ichristie.com/"},
      {name:"Builders Dublin",trade:"Builder",city:"Dublin",phone:"35314851330",dp:"014851330",fn:"",web:"https://buildersdublin.ie/"},
      {name:"Clancon Build",trade:"Builder",city:"Dublin",phone:"35318904373",dp:"018904373",fn:"",web:"https://clancon.ie/"},
      {name:"BuildMe Dublin",trade:"Builder",city:"Dublin",phone:"35312709051",dp:"012709051",fn:"",web:"https://buildme.ie/"},
      {name:"DS Construction",trade:"Builder",city:"Dublin",phone:"353872265559",dp:"0872265559",fn:"",web:"https://dsconstructionservices.ie/"},
      {name:"Plumber Gas Installer Limerick",trade:"Plumber",city:"Limerick",phone:"353876461132",dp:"0876461132",fn:"",web:"https://www.gaswork.ie/"},
      {name:"Professional Plumbing Limerick",trade:"Plumber",city:"Limerick",phone:"353877647119",dp:"0877647119",fn:"",web:"https://professionalplumbing.ie/"},
      {name:"Plumbing Services Limerick",trade:"Plumber",city:"Limerick",phone:"353838357426",dp:"0838357426",fn:"",web:"https://arconstruction.ie/plumbing-company/"},
      {name:"Pinnacle Group Limerick",trade:"Plumber",city:"Limerick",phone:"353879622222",dp:"0879622222",fn:"",web:"https://pinnaclegroup.ie/plumbers-in-limerick/"},
      {name:"KJ Electrical Limerick",trade:"Electrician",city:"Limerick",phone:"353877489102",dp:"0877489102",fn:"",web:"https://www.kjelectrical.ie/"},
      {name:"Limerick Electricians",trade:"Electrician",city:"Limerick",phone:"353892565413",dp:"0892565413",fn:"",web:"https://www.limerickelectricians.ie/electrical-emergency-limerick/"},
      {name:"Builders Limerick County",trade:"Builder",city:"Limerick",phone:"353876863000",dp:"0876863000",fn:"",web:"https://www.goldenpages.ie/builders/limerick-county/"},
      {name:"Galway Plumbing Solutions",trade:"Plumber",city:"Galway",phone:"353851720646",dp:"0851720646",fn:"",web:"https://www.galwayplumbingsolutions.ie/"},
      {name:"Plumber Galway",trade:"Plumber",city:"Galway",phone:"353896177808",dp:"0896177808",fn:"",web:"https://esda.ie/listing/plumber-galway/"},
      {name:"Heating & Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353863361645",dp:"0863361645",fn:"",web:"https://classifieds.advertiser.ie/services-available/heating-plumbing/"},
      {name:"Galway Plumbing Solutions FB",trade:"Plumber",city:"Galway",phone:"353851720646b",dp:"+353851720646",fn:"",web:"https://www.facebook.com/Galwayplumbingsolutions/"},
      {name:"Emergency Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353833638883",dp:"+353833638883",fn:"",web:"https://galwaypropertyservices.ie/plumbing-service"},
      {name:"PB Gibbons Electrical",trade:"Electrician",city:"Galway",phone:"353874215886",dp:"0874215886",fn:"",web:"https://www.facebook.com/pbgibbonselectricalltd/"},
      {name:"Electrician Galway",trade:"Electrician",city:"Galway",phone:"353877372236",dp:"0877372236",fn:"",web:"http://www.electriciangalway.net/index.php/contact-us/"},
      {name:"MD Electrics",trade:"Electrician",city:"Galway",phone:"353872303388",dp:"0872303388",fn:"",web:"https://mdelectrics.ie/"},
      {name:"Galway Electrical Services",trade:"Electrician",city:"Galway",phone:"353879044167",dp:"0879044167",fn:"",web:"https://www.galwayelectricalservices.ie/"},
      {name:"Moycullen Electrical",trade:"Electrician",city:"Galway",phone:"353879644477",dp:"0879644477",fn:"",web:"https://www.facebook.com/p/Moycullen-Electrical-100070243419698/"},
      {name:"Emergency Electrician Galway",trade:"Electrician",city:"Galway",phone:"353862508743",dp:"0862508743",fn:"",web:"https://www.martinon.ie/pagee371.html?id=18"},
      {name:"Emergency Electricians Galway",trade:"Electrician",city:"Galway",phone:"353838929402",dp:"0838929402",fn:"",web:"https://electrician-galway.ie/"},
      {name:"Electrician in Galway",trade:"Electrician",city:"Galway",phone:"353872224230",dp:"0872224230",fn:"",web:"https://www.hotfrog.ie/search/galway/electrician"},
      {name:"Builders in Galway",trade:"Builder",city:"Galway",phone:"353877375329",dp:"0877375329",fn:"",web:"http://www.fvgconstruction.ie/"},
      {name:"Tom Noone Construction",trade:"Builder",city:"Galway",phone:"353879517022",dp:"+353879517022",fn:"Tom",web:"https://www.facebook.com/p/Tom-Noone-Construction-Ltd-100063467171741/"},
      {name:"DR Heating Plumbing Waterford",trade:"Plumber",city:"Waterford",phone:"353858680890",dp:"0858680890",fn:"",web:"https://www.drheatingplumbing.com/"},
      {name:"Joe Waller Plumbing",trade:"Plumber",city:"Waterford",phone:"353872456184",dp:"0872456184",fn:"",web:"https://joewallerplumbing.ie/"},
      {name:"James Melay Electrical",trade:"Electrician",city:"Waterford",phone:"353872387119",dp:"0872387119",fn:"James",web:"https://about.me/jamesmelay"},
      {name:"Hickeys Plumbing",trade:"Plumber",city:"Cork",phone:"353872935996",dp:"0872935996",fn:"",web:"https://hickeysplumbing.ie/"},
      {name:"General Plumbing Cork",trade:"Plumber",city:"Cork",phone:"353866642391",dp:"0866642391",fn:"",web:"https://aturnerplumbing.ie/general-plumbing/"},
      {name:"O'Brien Plumbing & Heating",trade:"Plumber",city:"Cork",phone:"353871234567",dp:"0871234567",fn:"",web:"https://trades.connecteire.ie/"},
      {name:"Plumbers Cork",trade:"Plumber",city:"Cork",phone:"353876740965",dp:"0876740965",fn:"",web:"http://www.findaplumber.ie/corkplumbers.html"},
      {name:"Cork Plumbing Services",trade:"Plumber",city:"Cork",phone:"353873592245",dp:"0873592245",fn:"",web:"https://www.corkplumbingservices.com/"},
      {name:"Electrician Dublin 24/7",trade:"Electrician",city:"Dublin",phone:"353871707087",dp:"0871707087",fn:"",web:"https://robbieburkeelectrical.ie/"},
      {name:"AMR Electrical Contractors",trade:"Electrician",city:"Dublin",phone:"353876992788",dp:"+353876992788",fn:"",web:"https://www.amrelectrical.ie/"},
      {name:"24 Hour Emergency Electricians",trade:"Electrician",city:"Dublin",phone:"353877414362",dp:"+353877414362",fn:"",web:"https://www.facebook.com/myelectrician.ie/"},
      {name:"JHBC Galway",trade:"Builder",city:"Galway",phone:"353872887431",dp:"0872887431",fn:"",web:"https://www.jhbc.ie/contact/"},
      {name:"Kildare Plumbing and Heating",trade:"Plumber",city:"Kildare",phone:"353868389326",dp:"0868389326",fn:"",web:"https://esda.ie/listing/kildare-plumbing-and-heating/"},
      {name:"Waterworx Plumbing",trade:"Plumber",city:"Kildare",phone:"353872348469",dp:"0872348469",fn:"",web:"https://www.waterworx.ie/plumbing-services"},
      {name:"Plumber Kildare",trade:"Plumber",city:"Kildare",phone:"353861660883",dp:"0861660883",fn:"",web:""},
      {name:"Electricians Wexford",trade:"Electrician",city:"Wexford",phone:"353866057064",dp:"0866057064",fn:"",web:"http://www.goreyonline.com/electricians.html"},
      {name:"Kevin Moore Building",trade:"Builder",city:"Kilkenny",phone:"353567762602",dp:"0567762602",fn:"Kevin",web:"https://www.kevinmooreltd.com/"},
      {name:"Plumbing & Heating Sligo",trade:"Plumber",city:"Sligo",phone:"353878070352",dp:"0878070352",fn:"",web:"https://plumberandheatingsligo.com/"},
      {name:"Sligo Plumber",trade:"Plumber",city:"Sligo",phone:"353872903690",dp:"0872903690",fn:"",web:"https://sligoplumber.com/contact"},
      {name:"Emergency Plumber Sligo",trade:"Plumber",city:"Sligo",phone:"353873410745",dp:"0873410745",fn:"",web:"https://emergencyplumbersligo.com/"},
      {name:"Plumbers in Sligo",trade:"Plumber",city:"Sligo",phone:"353877085922",dp:"0877085922",fn:"",web:"https://www.constructionireland.ie/d_s/4,-1/sligo/plumbers"},
      {name:"Tom Leydon Plumbing",trade:"Plumber",city:"Sligo",phone:"353878217547",dp:"0878217547",fn:"Tom",web:"https://www.worksy.ie/businesses/ac8ce4b5-29ff-482f-b2c6-2196f7fb6c3c"},
      {name:"AMS Plumbing Sligo",trade:"Plumber",city:"Sligo",phone:"353872414466",dp:"0872414466",fn:"",web:"http://amsplumbing.ie/"},
      {name:"Sligo Plumbers",trade:"Plumber",city:"Sligo",phone:"353879222131",dp:"0879222131",fn:"",web:"https://www.locallife.ie/sligo/plumbers.asp"},
      {name:"Sean Browne Electrical",trade:"Electrician",city:"Mayo",phone:"353872676322",dp:"0872676322",fn:"Sean",web:"https://www.our.ie/county-mayo/claremorris/trades/sean-browne-electrical/browneelectrical/"},
      {name:"Stevie Kiernan Plumbing",trade:"Plumber",city:"Drogheda",phone:"353879019509",dp:"+353879019509",fn:"Stevie",web:"https://www.facebook.com/steviekph/"},
      {name:"EPC Plumbing Drogheda",trade:"Plumber",city:"Drogheda",phone:"353872788522",dp:"0872788522",fn:"",web:"https://www.epcplumbingheating.ie/contacts.htm"},
      {name:"All Out Plumbing & Heating",trade:"Plumber",city:"Drogheda",phone:"353857746691",dp:"+353857746691",fn:"",web:"https://www.facebook.com/Idjfhg/"},
      {name:"Drain Cleaning Drogheda",trade:"Plumber",city:"Drogheda",phone:"353861249070",dp:"0861249070",fn:"",web:"https://dublinplumbingservices.ie/drain-cleaning-services-drogheda-county-louth/"},
      {name:"Torc Electric",trade:"Electrician",city:"Athlone",phone:"353906492449",dp:"0906492449",fn:"",web:"https://www.torcelectric.ie/"},
      {name:"Sean Allen Heating & Plumbing",trade:"Plumber",city:"Tralee",phone:"353838735807",dp:"+353838735807",fn:"Sean",web:"https://www.facebook.com/SALHeating/"},
      {name:"Tralee Plumbers",trade:"Plumber",city:"Tralee",phone:"353667133611",dp:"0667133611",fn:"",web:"https://www.locallife.ie/tralee/plumbers.asp"},
      {name:"Bennis Water Plumbing",trade:"Plumber",city:"Tralee",phone:"353872931673",dp:"0872931673",fn:"",web:"https://esda.ie/listing/bennis-water-plumbing-services/"},
      {name:"GOC Plumbing & Heating",trade:"Plumber",city:"Tralee",phone:"353873331789",dp:"0873331789",fn:"",web:"https://www.gocplumbing.com/"},
      {name:"Fitz Plumbing Clare",trade:"Plumber",city:"Clare",phone:"353876792272",dp:"0876792272",fn:"",web:"https://fitzplumbingandheating.com/"},
      {name:"Electrician Tipperary",trade:"Electrician",city:"Tipperary",phone:"353879924510",dp:"0879924510",fn:"",web:"http://jobel.ie/"},
      {name:"Mark Barrett MEB Services",trade:"Plumber",city:"Carlow",phone:"353872753675",dp:"0872753675",fn:"Mark",web:""},
      {name:"Plumbing Contractor Carlow",trade:"Plumber",city:"Carlow",phone:"353876162614",dp:"0876162614",fn:"",web:""},
      {name:"24hr Emergency Plumber Carlow",trade:"Plumber",city:"Carlow",phone:"353863029355",dp:"0863029355",fn:"",web:""},
      {name:"John Lawlor Plumbing",trade:"Plumber",city:"Carlow",phone:"353879031249",dp:"0879031249",fn:"John",web:""},
      {name:"Pollerton Plumbing",trade:"Plumber",city:"Carlow",phone:"353599139259",dp:"0599139259",fn:"",web:""},
      {name:"Carlow Plumbing Services",trade:"Plumber",city:"Carlow",phone:"353599143460",dp:"0599143460",fn:"",web:""},
      {name:"Paul McGrath Heating & Plumbing",trade:"Plumber",city:"Carlow",phone:"353871234567b",dp:"0871234567",fn:"Paul",web:""}
    ];

    // ── Message templates ──
    function getDefaultMessage(c) {
      const g = c.fn ? `Hi ${c.fn}` : `Hi there at ${c.name}`;
      const t = {
        Plumber: `${g}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next plumber on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 plumbers in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Electrician: `${g}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next sparky on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 electricians in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Builder: `${g}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next builder on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 builders in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`
      };
      return t[c.trade] || t.Plumber;
    }

    // ── State ──
    let sentMap = {};
    let customMsgs = {};
    let currentFilter = 'all';
    let searchTerm = '';

    // ── Supabase sync ──
    async function loadFromSupabase() {
      try {
        const rows = await sbFetch('outreach_contacts?select=phone,sent,notes');
        rows.forEach(r => {
          if (r.sent) sentMap[r.phone] = true;
          if (r.notes) customMsgs[r.phone] = r.notes;
        });
        setSync(true);
      } catch (e) {
        console.error('Load failed:', e);
        sentMap = JSON.parse(localStorage.getItem('wa-sent') || '{}');
        customMsgs = JSON.parse(localStorage.getItem('wa-msgs') || '{}');
        setSync(false);
      }
    }

    async function saveToSupabase(phone, sent, customMsg) {
      if (sent !== undefined) {
        if (sent) sentMap[phone] = true; else delete sentMap[phone];
        localStorage.setItem('wa-sent', JSON.stringify(sentMap));
      }
      if (customMsg !== undefined) {
        if (customMsg) customMsgs[phone] = customMsg; else delete customMsgs[phone];
        localStorage.setItem('wa-msgs', JSON.stringify(customMsgs));
      }
      try {
        const body = { phone, updated_at: new Date().toISOString() };
        if (sent !== undefined) { body.sent = !!sent; body.sent_at = sent ? new Date().toISOString() : null; }
        if (customMsg !== undefined) body.notes = customMsg || null;
        await sbFetch('outreach_contacts', {
          method: 'POST',
          headers: { 'Prefer': 'return=representation,resolution=merge-duplicates' },
          body: JSON.stringify(body)
        });
      } catch (e) {
        console.error('Save failed:', e);
        setSync(false);
      }
    }

    function setSync(ok) {
      const dot = document.getElementById('sync-dot');
      const lbl = document.getElementById('sync-label');
      dot.className = 'sync-dot ' + (ok ? 'sync-ok' : 'sync-err');
      lbl.textContent = ok ? 'synced' : 'offline';
    }

    // ── Helpers ──
    function getSentCount() { return Object.values(sentMap).filter(Boolean).length; }
    function updateCounter() { document.getElementById('sent-count').textContent = getSentCount(); }
    function getMsg(c) { return customMsgs[c.phone] || getDefaultMessage(c); }
    function waLink(c) {
      const p = c.phone.replace(/[a-z]$/i, '');
      return `https://wa.me/${p}?text=${encodeURIComponent(getMsg(c))}`;
    }

    // ── Render ──
    const container = document.getElementById('contacts-container');

    function renderContacts() {
      container.innerHTML = '';
      let filtered = currentFilter === 'all' ? [...contacts] : contacts.filter(c => c.trade === currentFilter);
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = filtered.filter(c =>
          c.name.toLowerCase().includes(q) ||
          c.city.toLowerCase().includes(q) ||
          c.dp.includes(q) ||
          (c.fn && c.fn.toLowerCase().includes(q))
        );
      }
      document.getElementById('total-shown').textContent = filtered.length;

      let currentCity = '';
      filtered.forEach(contact => {
        if (contact.city !== currentCity) {
          currentCity = contact.city;
          const count = filtered.filter(c => c.city === currentCity).length;
          const h = document.createElement('div');
          h.className = 'batch-header';
          h.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${currentCity} (${count})`;
          container.appendChild(h);
        }

        const isSent = sentMap[contact.phone] || false;
        const hasCustom = !!customMsgs[contact.phone];
        let webHost = '';
        try { webHost = contact.web ? new URL(contact.web).hostname.replace('www.','') : ''; } catch(e) {}

        const div = document.createElement('div');
        div.className = 'contact' + (isSent ? ' sent' : '');
        div.dataset.phone = contact.phone;
        div.innerHTML = `
          <div class="contact-row">
            <input type="checkbox" class="sent-check" data-phone="${contact.phone}" ${isSent ? 'checked' : ''}>
            <div class="contact-info">
              <div class="contact-name">
                <span class="trade-badge trade-${contact.trade}">${contact.trade}</span>
                ${contact.fn ? `<strong>${contact.fn}</strong> &mdash; ` : ''}${contact.name}
              </div>
              <div class="contact-details">
                ${contact.city} &middot; ${contact.dp}${webHost ? ` &middot; <a href="${contact.web}" target="_blank" title="${contact.web}">${webHost}</a>` : ''}
              </div>
            </div>
            <div class="contact-actions">
              <button class="edit-btn${hasCustom ? ' active' : ''}" data-phone="${contact.phone}" title="Edit message">&#9998;</button>
              <a href="${waLink(contact)}" target="_blank" class="whatsapp-btn" data-phone="${contact.phone}">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                Send
              </a>
            </div>
          </div>
          <div class="message-editor" id="editor-${contact.phone}">
            <textarea data-phone="${contact.phone}">${getMsg(contact)}</textarea>
            <div class="editor-actions">
              <small class="${hasCustom ? 'custom' : ''}">${hasCustom ? 'Custom message' : 'Default template'}</small>
              <button class="reset-msg-btn" data-phone="${contact.phone}">Reset to default</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      updateCounter();
    }

    // ── Events ──
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderContacts();
      });
    });

    document.getElementById('search').addEventListener('input', function() {
      searchTerm = this.value;
      renderContacts();
    });

    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('sent-check')) {
        const phone = e.target.dataset.phone;
        e.target.closest('.contact').classList.toggle('sent', e.target.checked);
        saveToSupabase(phone, e.target.checked, undefined);
        updateCounter();
      }
    });

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.whatsapp-btn');
      if (btn) {
        const phone = btn.dataset.phone;
        const row = btn.closest('.contact');
        row.classList.add('sent');
        row.querySelector('.sent-check').checked = true;
        saveToSupabase(phone, true, undefined);
        updateCounter();
      }
      if (e.target.classList.contains('edit-btn')) {
        const phone = e.target.dataset.phone;
        const editor = document.getElementById('editor-' + phone);
        editor.classList.toggle('open');
        e.target.classList.toggle('active', editor.classList.contains('open') || !!customMsgs[phone]);
      }
      if (e.target.classList.contains('reset-msg-btn')) {
        const phone = e.target.dataset.phone;
        const contact = contacts.find(c => c.phone === phone);
        const msg = getDefaultMessage(contact);
        const editor = document.getElementById('editor-' + phone);
        editor.querySelector('textarea').value = msg;
        delete customMsgs[phone];
        saveToSupabase(phone, undefined, '');
        const row = editor.closest('.contact');
        const waBtn = row.querySelector('.whatsapp-btn');
        waBtn.href = `https://wa.me/${phone.replace(/[a-z]$/i,'')}?text=${encodeURIComponent(msg)}`;
        editor.querySelector('.editor-actions small').textContent = 'Default template';
        editor.querySelector('.editor-actions small').className = '';
        row.querySelector('.edit-btn').classList.remove('active');
      }
    });

    document.addEventListener('input', function(e) {
      if (e.target.tagName === 'TEXTAREA' && e.target.dataset.phone) {
        const phone = e.target.dataset.phone;
        const contact = contacts.find(c => c.phone === phone);
        const def = getDefaultMessage(contact);
        const val = e.target.value;
        const isCustom = val !== def;

        if (isCustom) customMsgs[phone] = val; else delete customMsgs[phone];
        clearTimeout(e.target._t);
        e.target._t = setTimeout(() => saveToSupabase(phone, undefined, isCustom ? val : ''), 800);

        const row = e.target.closest('.contact');
        row.querySelector('.whatsapp-btn').href = `https://wa.me/${phone.replace(/[a-z]$/i,'')}?text=${encodeURIComponent(val)}`;
        const sm = row.querySelector('.editor-actions small');
        sm.textContent = isCustom ? 'Custom message' : 'Default template';
        sm.className = isCustom ? 'custom' : '';
      }
    });

    function resetAll() {
      if (!confirm('Reset all sent markers and custom messages?')) return;
      sentMap = {}; customMsgs = {};
      localStorage.removeItem('wa-sent');
      localStorage.removeItem('wa-msgs');
      sbFetch('outreach_contacts', { method: 'DELETE', headers: { 'Prefer': '' } }).catch(() => {});
      renderContacts();
    }

    // ── Init ──
    (async () => {
      await loadFromSupabase();
      renderContacts();
    })();
    </script>
</body>
</html>
