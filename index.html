<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Quick Send - Ringvox Outreach</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #25D366;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 22px;
            margin-bottom: 6px;
        }
        .tip { font-size: 13px; color: #666; margin-bottom: 12px; }
        .tip strong { color: #333; }
        .sync-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-left: 10px;
        }
        .sync-ok { background: #e8f5e9; color: #2e7d32; }
        .sync-err { background: #fce4ec; color: #c62828; }
        .sync-loading { background: #fff3e0; color: #e65100; }
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-btn.active { border-color: #25D366; background: #e8f5e9; color: #25D366; }
        .filter-btn:hover { border-color: #25D366; }

        .contact {
            background: white;
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .contact.sent { opacity: 0.45; }
        .contact.sent .whatsapp-btn { background: #999; pointer-events: none; }
        .contact-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sent-check {
            width: 20px; height: 20px;
            cursor: pointer;
            accent-color: #25D366;
            flex-shrink: 0;
        }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: bold; font-size: 14px; color: #333; }
        .contact-details { font-size: 12px; color: #888; margin-top: 2px; }
        .contact-details a { color: #1565c0; text-decoration: none; }
        .contact-details a:hover { text-decoration: underline; }
        .trade-badge {
            display: inline-block; font-size: 11px; font-weight: 600;
            padding: 2px 8px; border-radius: 10px; margin-right: 6px;
        }
        .trade-Plumber { background: #e3f2fd; color: #1565c0; }
        .trade-Electrician { background: #fff3e0; color: #e65100; }
        .trade-Builder { background: #e8f5e9; color: #2e7d32; }

        .contact-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }
        .whatsapp-btn {
            background: #25D366; color: white; border: none;
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-size: 13px; font-weight: 600; text-decoration: none;
            display: inline-flex; align-items: center; gap: 6px;
            transition: background 0.2s; white-space: nowrap;
        }
        .whatsapp-btn:hover { background: #20BA5A; }
        .edit-btn {
            background: none; border: 1px solid #ddd; border-radius: 6px;
            padding: 7px 10px; cursor: pointer; font-size: 13px; color: #666;
            transition: all 0.2s;
        }
        .edit-btn:hover { border-color: #999; color: #333; }
        .edit-btn.active { border-color: #1565c0; color: #1565c0; background: #e3f2fd; }

        .message-editor {
            display: none;
            margin-top: 10px;
            position: relative;
        }
        .message-editor.open { display: block; }
        .message-editor textarea {
            width: 100%;
            min-height: 180px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
            color: #333;
        }
        .message-editor textarea:focus { border-color: #25D366; outline: none; }
        .editor-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }
        .editor-actions small { color: #999; font-size: 11px; }
        .reset-msg-btn {
            font-size: 11px; color: #999; background: none; border: none;
            cursor: pointer; text-decoration: underline;
        }
        .reset-msg-btn:hover { color: #666; }

        .batch-header {
            background: #FF6B00; color: white;
            padding: 8px 16px; border-radius: 6px;
            margin: 20px 0 6px 0; font-weight: bold; font-size: 13px;
            position: sticky; top: 0; z-index: 100;
        }
        .progress {
            position: fixed; top: 15px; right: 15px;
            background: white; padding: 10px 14px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; text-align: center;
        }
        .progress-number { font-size: 22px; font-weight: bold; color: #25D366; }
        .progress small { font-size: 11px; color: #666; display: block; }
        .progress button {
            font-size: 10px; color: #999; background: none;
            border: none; cursor: pointer; margin-top: 4px;
        }
        .progress button:hover { color: #dc3545; }
    </style>
</head>
<body>
    <div class="progress">
        <div class="progress-number" id="sent-count">0</div>
        <small>of <span id="total-shown">100</span> sent</small>
        <button onclick="resetAll()">reset</button>
    </div>

    <h1>
        <svg width="22" height="22" fill="#25D366" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
        WhatsApp Quick Send
        <span class="sync-status sync-loading" id="sync-badge">syncing...</span>
    </h1>
    <div class="tip">Click <strong>Send</strong> to open WhatsApp with pre-filled message. <strong>Edit</strong> to tweak a message before sending.</div>

    <div class="filters">
        <button class="filter-btn active" data-filter="all">All (100)</button>
        <button class="filter-btn" data-filter="Plumber">Plumbers (60)</button>
        <button class="filter-btn" data-filter="Electrician">Electricians (25)</button>
        <button class="filter-btn" data-filter="Builder">Builders (15)</button>
    </div>

    <div id="contacts-container"></div>

    <script>
    // ── Supabase config ──
    const SUPABASE_URL = 'https://nantnllmvftqmrwjorqe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbnRubGxtdmZ0cW1yd2pvcnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzQyOTYsImV4cCI6MjA4NjkxMDI5Nn0.os0CptUMkUxRXLm3_EsJq9GimwGKtUSNZ9hiQ7cLNsU';

    async function sbFetch(path, opts = {}) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
        ...opts,
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation',
          ...(opts.headers || {})
        }
      });
      if (!res.ok) throw new Error(`Supabase ${res.status}`);
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    // ── Contact data (with website URLs) ──
    const contacts = [
      {name:"Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871660582",dp:"0871660582",fn:"",web:"https://aturnerplumbing.ie/"},
      {name:"Pat Kelleher Plumbing",trade:"Plumber",city:"Cork",phone:"353879730364",dp:"0879730364",fn:"Pat",web:"https://www.kelleherplumbing.ie/"},
      {name:"Emergency Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871345062",dp:"0871345062",fn:"",web:"https://gaselectricalservices.ie/emergency-call-out/"},
      {name:"Tony Leahy Heating & Plumbing",trade:"Plumber",city:"Cork",phone:"353879223332",dp:"0879223332",fn:"Tony",web:"http://www.tonyleahyheatingandplumbingservices.ie/"},
      {name:"Plumbing Maintenance and Call",trade:"Plumber",city:"Cork",phone:"353879470505",dp:"0879470505",fn:"",web:"https://crowleyplumbing.ie/plumbing-services/plumbing-maintenance-and-call-outs/"},
      {name:"Cork Enterprise Plumbing",trade:"Plumber",city:"Cork",phone:"353878507445",dp:"0878507445",fn:"",web:"https://www.corkenterpriseplumbing.com/"},
      {name:"Plumbers Cork County",trade:"Plumber",city:"Cork",phone:"353873955256",dp:"0873955256",fn:"",web:"https://www.goldenpages.ie/plumbers/cork-county/"},
      {name:"Cork Electrician",trade:"Electrician",city:"Cork",phone:"353868131570",dp:"0868131570",fn:"",web:"https://corkelectricianslimited.ie/"},
      {name:"Electricians Cork County",trade:"Electrician",city:"Cork",phone:"353862538477",dp:"0862538477",fn:"",web:"https://www.goldenpages.ie/electricians/cork-county/"},
      {name:"Electrician Cork",trade:"Electrician",city:"Cork",phone:"353877464011",dp:"0877464011",fn:"",web:"https://corkelectrical.ie/"},
      {name:"Electricians in Cork",trade:"Electrician",city:"Cork",phone:"353862563322",dp:"0862563322",fn:"",web:"https://www.hotfrog.ie/find/electricians/cork"},
      {name:"Small Builders Cork",trade:"Builder",city:"Cork",phone:"353874656330",dp:"0874656330",fn:"",web:"https://www.forgedconstruction.ie/"},
      {name:"Chris O'Donovan Construction",trade:"Builder",city:"Cork",phone:"353872335198",dp:"0872335198",fn:"Chris",web:"http://chrisodonovanconstruction.com/"},
      {name:"Builder Cork",trade:"Builder",city:"Cork",phone:"353872925951",dp:"0872925951",fn:"",web:"https://murtyosullivanbuilders.ie/"},
      {name:"Builders in Cork",trade:"Builder",city:"Cork",phone:"353872360514",dp:"+353872360514",fn:"",web:"https://www.constructionireland.ie/d_s/1,-1/cork/builders"},
      {name:"DKS Construction",trade:"Builder",city:"Cork",phone:"353876807226",dp:"0876807226",fn:"",web:"https://www.dksconstruction.ie/"},
      {name:"Building Contractors Cork",trade:"Builder",city:"Cork",phone:"353214859032",dp:"0214859032",fn:"",web:"https://chamber.corkchamber.ie/list/category/building-contractors-providers-10"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863579495",dp:"0863579495",fn:"",web:"https://plumber-dublin.ie/"},
      {name:"24 Hour Plumber",trade:"Plumber",city:"Dublin",phone:"353858556111",dp:"0858556111",fn:"",web:"https://www.24hourplumber.ie"},
      {name:"Plumbers Dublin County",trade:"Plumber",city:"Dublin",phone:"353862345954",dp:"0862345954",fn:"",web:"https://www.goldenpages.ie/plumbers/dublin-dublin-county/"},
      {name:"The Dublin Plumber",trade:"Plumber",city:"Dublin",phone:"353858667631",dp:"0858667631",fn:"",web:"https://www.thedublinplumber.ie/"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863748000",dp:"0863748000",fn:"",web:"https://dublinplumber24hrs.ie/"},
      {name:"Plumber Dublin 24/7",trade:"Plumber",city:"Dublin",phone:"35314851554",dp:"014851554",fn:"",web:"https://plumbers247.net/"},
      {name:"Plumber Dublin 12",trade:"Plumber",city:"Dublin",phone:"35315143300",dp:"015143300",fn:"",web:"https://www.dewarplumbers.ie/plumber-dublin-12.html"},
      {name:"Kieron Murphy Plumbing",trade:"Plumber",city:"Dublin",phone:"353872768007",dp:"0872768007",fn:"Kieron",web:"https://plumbingheating.ie/"},
      {name:"RapidPlumb",trade:"Plumber",city:"Dublin",phone:"353851054991",dp:"0851054991",fn:"",web:"https://www.rapidplumb.ie/"},
      {name:"Emergency Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353866049361",dp:"0866049361",fn:"",web:"https://www.sidsplumbing.ie/"},
      {name:"Dublin Plumbing",trade:"Plumber",city:"Dublin",phone:"35315354268",dp:"015354268",fn:"",web:"https://dublinplumbing.ie/contact-us/"},
      {name:"House Rewire Dublin",trade:"Electrician",city:"Dublin",phone:"353858238132",dp:"0858238132",fn:"",web:"https://dublin-electricians.ie/"},
      {name:"Mobile Auto Electrician Dublin",trade:"Electrician",city:"Dublin",phone:"353852332555",dp:"0852332555",fn:"",web:"https://www.mobileautoelectrician.ie/"},
      {name:"Clontarf Electrician",trade:"Electrician",city:"Dublin",phone:"353862525331",dp:"0862525331",fn:"",web:"https://www.ichristie.com/"},
      {name:"Builders Dublin",trade:"Builder",city:"Dublin",phone:"35314851330",dp:"014851330",fn:"",web:"https://buildersdublin.ie/"},
      {name:"Clancon Build",trade:"Builder",city:"Dublin",phone:"35318904373",dp:"018904373",fn:"",web:"https://clancon.ie/"},
      {name:"BuildMe Dublin",trade:"Builder",city:"Dublin",phone:"35312709051",dp:"012709051",fn:"",web:"https://buildme.ie/"},
      {name:"DS Construction",trade:"Builder",city:"Dublin",phone:"353872265559",dp:"0872265559",fn:"",web:"https://dsconstructionservices.ie/"},
      {name:"Plumber Gas Installer Limerick",trade:"Plumber",city:"Limerick",phone:"353876461132",dp:"0876461132",fn:"",web:"https://www.gaswork.ie/"},
      {name:"Professional Plumbing Limerick",trade:"Plumber",city:"Limerick",phone:"353877647119",dp:"0877647119",fn:"",web:"https://professionalplumbing.ie/"},
      {name:"Plumbing Services Limerick",trade:"Plumber",city:"Limerick",phone:"353838357426",dp:"0838357426",fn:"",web:"https://arconstruction.ie/plumbing-company/"},
      {name:"Pinnacle Group Limerick",trade:"Plumber",city:"Limerick",phone:"353879622222",dp:"0879622222",fn:"",web:"https://pinnaclegroup.ie/plumbers-in-limerick/"},
      {name:"KJ Electrical Limerick",trade:"Electrician",city:"Limerick",phone:"353877489102",dp:"0877489102",fn:"",web:"https://www.kjelectrical.ie/"},
      {name:"Limerick Electricians",trade:"Electrician",city:"Limerick",phone:"353892565413",dp:"0892565413",fn:"",web:"https://www.limerickelectricians.ie/electrical-emergency-limerick/"},
      {name:"Builders Limerick County",trade:"Builder",city:"Limerick",phone:"353876863000",dp:"0876863000",fn:"",web:"https://www.goldenpages.ie/builders/limerick-county/"},
      {name:"Galway Plumbing Solutions",trade:"Plumber",city:"Galway",phone:"353851720646",dp:"0851720646",fn:"",web:"https://www.galwayplumbingsolutions.ie/"},
      {name:"Plumber Galway",trade:"Plumber",city:"Galway",phone:"353896177808",dp:"0896177808",fn:"",web:"https://esda.ie/listing/plumber-galway/"},
      {name:"Heating & Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353863361645",dp:"0863361645",fn:"",web:"https://classifieds.advertiser.ie/services-available/heating-plumbing/"},
      {name:"Galway Plumbing Solutions FB",trade:"Plumber",city:"Galway",phone:"353851720646b",dp:"+353851720646",fn:"",web:"https://www.facebook.com/Galwayplumbingsolutions/"},
      {name:"Emergency Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353833638883",dp:"+353833638883",fn:"",web:"https://galwaypropertyservices.ie/plumbing-service"},
      {name:"PB Gibbons Electrical",trade:"Electrician",city:"Galway",phone:"353874215886",dp:"0874215886",fn:"",web:"https://www.facebook.com/pbgibbonselectricalltd/"},
      {name:"Electrician Galway",trade:"Electrician",city:"Galway",phone:"353877372236",dp:"0877372236",fn:"",web:"http://www.electriciangalway.net/index.php/contact-us/"},
      {name:"MD Electrics",trade:"Electrician",city:"Galway",phone:"353872303388",dp:"0872303388",fn:"",web:"https://mdelectrics.ie/"},
      {name:"Galway Electrical Services",trade:"Electrician",city:"Galway",phone:"353879044167",dp:"0879044167",fn:"",web:"https://www.galwayelectricalservices.ie/"},
      {name:"Moycullen Electrical",trade:"Electrician",city:"Galway",phone:"353879644477",dp:"0879644477",fn:"",web:"https://www.facebook.com/p/Moycullen-Electrical-100070243419698/"},
      {name:"Emergency Electrician Galway",trade:"Electrician",city:"Galway",phone:"353862508743",dp:"0862508743",fn:"",web:"https://www.martinon.ie/pagee371.html?id=18"},
      {name:"Emergency Electricians Galway",trade:"Electrician",city:"Galway",phone:"353838929402",dp:"0838929402",fn:"",web:"https://electrician-galway.ie/"},
      {name:"Electrician in Galway",trade:"Electrician",city:"Galway",phone:"353872224230",dp:"0872224230",fn:"",web:"https://www.hotfrog.ie/search/galway/electrician"},
      {name:"Builders in Galway",trade:"Builder",city:"Galway",phone:"353877375329",dp:"0877375329",fn:"",web:"http://www.fvgconstruction.ie/"},
      {name:"Tom Noone Construction",trade:"Builder",city:"Galway",phone:"353879517022",dp:"+353879517022",fn:"Tom",web:"https://www.facebook.com/p/Tom-Noone-Construction-Ltd-100063467171741/"},
      {name:"DR Heating Plumbing Waterford",trade:"Plumber",city:"Waterford",phone:"353858680890",dp:"0858680890",fn:"",web:"https://www.drheatingplumbing.com/"},
      {name:"Joe Waller Plumbing",trade:"Plumber",city:"Waterford",phone:"353872456184",dp:"0872456184",fn:"",web:"https://joewallerplumbing.ie/"},
      {name:"James Melay Electrical",trade:"Electrician",city:"Waterford",phone:"353872387119",dp:"0872387119",fn:"James",web:"https://about.me/jamesmelay"},
      {name:"Hickeys Plumbing",trade:"Plumber",city:"Cork",phone:"353872935996",dp:"0872935996",fn:"",web:"https://hickeysplumbing.ie/"},
      {name:"General Plumbing Cork",trade:"Plumber",city:"Cork",phone:"353866642391",dp:"0866642391",fn:"",web:"https://aturnerplumbing.ie/general-plumbing/"},
      {name:"O'Brien Plumbing & Heating",trade:"Plumber",city:"Cork",phone:"353871234567",dp:"0871234567",fn:"",web:"https://trades.connecteire.ie/"},
      {name:"Plumbers Cork",trade:"Plumber",city:"Cork",phone:"353876740965",dp:"0876740965",fn:"",web:"http://www.findaplumber.ie/corkplumbers.html"},
      {name:"Cork Plumbing Services",trade:"Plumber",city:"Cork",phone:"353873592245",dp:"0873592245",fn:"",web:"https://www.corkplumbingservices.com/"},
      {name:"Electrician Dublin 24/7",trade:"Electrician",city:"Dublin",phone:"353871707087",dp:"0871707087",fn:"",web:"https://robbieburkeelectrical.ie/"},
      {name:"AMR Electrical Contractors",trade:"Electrician",city:"Dublin",phone:"353876992788",dp:"+353876992788",fn:"",web:"https://www.amrelectrical.ie/"},
      {name:"24 Hour Emergency Electricians",trade:"Electrician",city:"Dublin",phone:"353877414362",dp:"+353877414362",fn:"",web:"https://www.facebook.com/myelectrician.ie/"},
      {name:"JHBC Galway",trade:"Builder",city:"Galway",phone:"353872887431",dp:"0872887431",fn:"",web:"https://www.jhbc.ie/contact/"},
      {name:"Kildare Plumbing and Heating",trade:"Plumber",city:"Kildare",phone:"353868389326",dp:"0868389326",fn:"",web:"https://esda.ie/listing/kildare-plumbing-and-heating/"},
      {name:"Waterworx Plumbing",trade:"Plumber",city:"Kildare",phone:"353872348469",dp:"0872348469",fn:"",web:"https://www.waterworx.ie/plumbing-services"},
      {name:"Plumber Kildare",trade:"Plumber",city:"Kildare",phone:"353861660883",dp:"0861660883",fn:"",web:"https://www.reddit.com/r/AskIreland/comments/1817lbi/finding_a_proper_plumber_in_ireland/"},
      {name:"Electricians Wexford",trade:"Electrician",city:"Wexford",phone:"353866057064",dp:"0866057064",fn:"",web:"http://www.goreyonline.com/electricians.html"},
      {name:"Kevin Moore Building",trade:"Builder",city:"Kilkenny",phone:"353567762602",dp:"0567762602",fn:"Kevin",web:"https://www.kevinmooreltd.com/"},
      {name:"Plumbing & Heating Sligo",trade:"Plumber",city:"Sligo",phone:"353878070352",dp:"0878070352",fn:"",web:"https://plumberandheatingsligo.com/"},
      {name:"Sligo Plumber",trade:"Plumber",city:"Sligo",phone:"353872903690",dp:"0872903690",fn:"",web:"https://sligoplumber.com/contact"},
      {name:"Emergency Plumber Sligo",trade:"Plumber",city:"Sligo",phone:"353873410745",dp:"0873410745",fn:"",web:"https://emergencyplumbersligo.com/"},
      {name:"Plumbers in Sligo",trade:"Plumber",city:"Sligo",phone:"353877085922",dp:"0877085922",fn:"",web:"https://www.constructionireland.ie/d_s/4,-1/sligo/plumbers"},
      {name:"Tom Leydon Plumbing",trade:"Plumber",city:"Sligo",phone:"353878217547",dp:"0878217547",fn:"Tom",web:"https://www.worksy.ie/businesses/ac8ce4b5-29ff-482f-b2c6-2196f7fb6c3c"},
      {name:"AMS Plumbing Sligo",trade:"Plumber",city:"Sligo",phone:"353872414466",dp:"0872414466",fn:"",web:"http://amsplumbing.ie/"},
      {name:"Sligo Plumbers",trade:"Plumber",city:"Sligo",phone:"353879222131",dp:"0879222131",fn:"",web:"https://www.locallife.ie/sligo/plumbers.asp"},
      {name:"Sean Browne Electrical",trade:"Electrician",city:"Mayo",phone:"353872676322",dp:"0872676322",fn:"Sean",web:"https://www.our.ie/county-mayo/claremorris/trades/sean-browne-electrical/browneelectrical/"},
      {name:"Stevie Kiernan Plumbing",trade:"Plumber",city:"Drogheda",phone:"353879019509",dp:"+353879019509",fn:"Stevie",web:"https://www.facebook.com/steviekph/"},
      {name:"EPC Plumbing Drogheda",trade:"Plumber",city:"Drogheda",phone:"353872788522",dp:"0872788522",fn:"",web:"https://www.epcplumbingheating.ie/contacts.htm"},
      {name:"All Out Plumbing & Heating",trade:"Plumber",city:"Drogheda",phone:"353857746691",dp:"+353857746691",fn:"",web:"https://www.facebook.com/Idjfhg/"},
      {name:"Drain Cleaning Drogheda",trade:"Plumber",city:"Drogheda",phone:"353861249070",dp:"0861249070",fn:"",web:"https://dublinplumbingservices.ie/drain-cleaning-services-drogheda-county-louth/"},
      {name:"Torc Electric",trade:"Electrician",city:"Athlone",phone:"353906492449",dp:"0906492449",fn:"",web:"https://www.torcelectric.ie/"},
      {name:"Sean Allen Heating & Plumbing",trade:"Plumber",city:"Tralee",phone:"353838735807",dp:"+353838735807",fn:"Sean",web:"https://www.facebook.com/SALHeating/"},
      {name:"Tralee Plumbers",trade:"Plumber",city:"Tralee",phone:"353667133611",dp:"0667133611",fn:"",web:"https://www.locallife.ie/tralee/plumbers.asp"},
      {name:"Bennis Water Plumbing",trade:"Plumber",city:"Tralee",phone:"353872931673",dp:"0872931673",fn:"",web:"https://esda.ie/listing/bennis-water-plumbing-services/"},
      {name:"GOC Plumbing & Heating",trade:"Plumber",city:"Tralee",phone:"353873331789",dp:"0873331789",fn:"",web:"https://www.gocplumbing.com/"},
      {name:"Fitz Plumbing Clare",trade:"Plumber",city:"Clare",phone:"353876792272",dp:"0876792272",fn:"",web:"https://fitzplumbingandheating.com/"},
      {name:"Electrician Tipperary",trade:"Electrician",city:"Tipperary",phone:"353879924510",dp:"0879924510",fn:"",web:"http://jobel.ie/"},
      {name:"Mark Barrett MEB Services",trade:"Plumber",city:"Carlow",phone:"353872753675",dp:"0872753675",fn:"Mark",web:""},
      {name:"Plumbing Contractor Carlow",trade:"Plumber",city:"Carlow",phone:"353876162614",dp:"0876162614",fn:"",web:""},
      {name:"24hr Emergency Plumber Carlow",trade:"Plumber",city:"Carlow",phone:"353863029355",dp:"0863029355",fn:"",web:""},
      {name:"John Lawlor Plumbing",trade:"Plumber",city:"Carlow",phone:"353879031249",dp:"0879031249",fn:"John",web:""},
      {name:"Pollerton Plumbing",trade:"Plumber",city:"Carlow",phone:"353599139259",dp:"0599139259",fn:"",web:""},
      {name:"Carlow Plumbing Services",trade:"Plumber",city:"Carlow",phone:"353599143460",dp:"0599143460",fn:"",web:""},
      {name:"Paul McGrath Heating & Plumbing",trade:"Plumber",city:"Carlow",phone:"353871234567b",dp:"0871234567",fn:"Paul",web:""}
    ];

    // ── Message templates ──
    function getDefaultMessage(contact) {
      const greeting = contact.fn ? `Hi ${contact.fn}` : 'Hi there';
      const templates = {
        Plumber: `${greeting}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next plumber on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 plumbers in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Electrician: `${greeting}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next sparky on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 electricians in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Builder: `${greeting}, Colm here from Ringvox in Limerick.\n\nDo you miss calls when you're on site? Most callers won't leave a voicemail, they just ring the next builder on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\nWe're opening it up to 10 builders in Ireland this week at \u20ac25/month (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`
      };
      return templates[contact.trade] || templates.Plumber;
    }

    // ── State ──
    let sentMap = {};       // phone -> true
    let customMsgs = {};    // phone -> custom message text
    let currentFilter = 'all';

    // ── Supabase sync ──
    async function loadFromSupabase() {
      try {
        const rows = await sbFetch('outreach_contacts?select=phone,sent,notes');
        rows.forEach(r => {
          if (r.sent) sentMap[r.phone] = true;
          if (r.notes) customMsgs[r.phone] = r.notes;
        });
        setBadge('synced', 'sync-ok');
      } catch (e) {
        console.error('Supabase load failed:', e);
        // Fall back to localStorage
        sentMap = JSON.parse(localStorage.getItem('wa-sent') || '{}');
        customMsgs = JSON.parse(localStorage.getItem('wa-msgs') || '{}');
        setBadge('offline', 'sync-err');
      }
    }

    async function saveToSupabase(phone, sent, customMsg) {
      // Always save locally first (instant)
      if (sent !== undefined) {
        if (sent) sentMap[phone] = true;
        else delete sentMap[phone];
        localStorage.setItem('wa-sent', JSON.stringify(sentMap));
      }
      if (customMsg !== undefined) {
        if (customMsg) customMsgs[phone] = customMsg;
        else delete customMsgs[phone];
        localStorage.setItem('wa-msgs', JSON.stringify(customMsgs));
      }

      // Then sync to Supabase
      try {
        const body = { phone };
        if (sent !== undefined) {
          body.sent = !!sent;
          body.sent_at = sent ? new Date().toISOString() : null;
        }
        if (customMsg !== undefined) body.notes = customMsg || null;
        body.updated_at = new Date().toISOString();

        await sbFetch('outreach_contacts', {
          method: 'POST',
          headers: { 'Prefer': 'return=representation,resolution=merge-duplicates' },
          body: JSON.stringify(body)
        });
      } catch (e) {
        console.error('Supabase save failed:', e);
        setBadge('offline', 'sync-err');
      }
    }

    function setBadge(text, cls) {
      const b = document.getElementById('sync-badge');
      b.textContent = text;
      b.className = 'sync-status ' + cls;
    }

    // ── Counter ──
    function getSentCount() { return Object.values(sentMap).filter(Boolean).length; }
    function updateCounter() { document.getElementById('sent-count').textContent = getSentCount(); }

    // ── Get message for a contact (custom or default) ──
    function getMsg(contact) {
      return customMsgs[contact.phone] || getDefaultMessage(contact);
    }

    // ── Build WhatsApp link ──
    function waLink(contact) {
      // Strip trailing letter from phone for duplicate keys like 353851720646b
      const cleanPhone = contact.phone.replace(/[a-z]$/i, '');
      return `https://wa.me/${cleanPhone}?text=${encodeURIComponent(getMsg(contact))}`;
    }

    // ── Render ──
    const container = document.getElementById('contacts-container');

    function renderContacts(filter) {
      currentFilter = filter;
      container.innerHTML = '';
      const filtered = filter === 'all' ? contacts : contacts.filter(c => c.trade === filter);
      document.getElementById('total-shown').textContent = filtered.length;

      let currentCity = '';
      filtered.forEach(contact => {
        if (contact.city !== currentCity) {
          currentCity = contact.city;
          const count = filtered.filter(c => c.city === currentCity).length;
          const header = document.createElement('div');
          header.className = 'batch-header';
          header.textContent = `${currentCity} (${count})`;
          container.appendChild(header);
        }

        const isSent = sentMap[contact.phone] || false;
        const hasCustom = !!customMsgs[contact.phone];
        const webHost = contact.web ? new URL(contact.web).hostname.replace('www.','') : '';

        const div = document.createElement('div');
        div.className = 'contact' + (isSent ? ' sent' : '');
        div.dataset.phone = contact.phone;
        div.innerHTML = `
          <div class="contact-row">
            <input type="checkbox" class="sent-check" data-phone="${contact.phone}" ${isSent ? 'checked' : ''} title="Mark as sent">
            <div class="contact-info">
              <div class="contact-name">
                <span class="trade-badge trade-${contact.trade}">${contact.trade}</span>
                ${contact.fn ? `<strong>${contact.fn}</strong> - ` : ''}${contact.name}
              </div>
              <div class="contact-details">
                ${contact.city} &middot; ${contact.dp}${webHost ? ` &middot; <a href="${contact.web}" target="_blank" title="${contact.web}">${webHost}</a>` : ''}
              </div>
            </div>
            <div class="contact-actions">
              <button class="edit-btn${hasCustom ? ' active' : ''}" data-phone="${contact.phone}" title="Edit message">&#9998;</button>
              <a href="${waLink(contact)}" target="_blank" class="whatsapp-btn" data-phone="${contact.phone}">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                Send
              </a>
            </div>
          </div>
          <div class="message-editor" id="editor-${contact.phone}">
            <textarea data-phone="${contact.phone}">${getMsg(contact)}</textarea>
            <div class="editor-actions">
              <small>${hasCustom ? 'Custom message' : 'Default template'}</small>
              <button class="reset-msg-btn" data-phone="${contact.phone}">Reset to default</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      updateCounter();
    }

    // ── Event handlers ──

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderContacts(btn.dataset.filter);
      });
    });

    // Checkbox toggle
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('sent-check')) {
        const phone = e.target.dataset.phone;
        const checked = e.target.checked;
        e.target.closest('.contact').classList.toggle('sent', checked);
        saveToSupabase(phone, checked, undefined);
        updateCounter();
      }
    });

    // Send button click - auto-mark as sent
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.whatsapp-btn');
      if (btn) {
        const phone = btn.dataset.phone;
        const row = btn.closest('.contact');
        row.classList.add('sent');
        row.querySelector('.sent-check').checked = true;
        saveToSupabase(phone, true, undefined);
        updateCounter();
      }
    });

    // Edit button toggle
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const phone = e.target.dataset.phone;
        const editor = document.getElementById('editor-' + phone);
        const isOpen = editor.classList.toggle('open');
        e.target.classList.toggle('active', isOpen || !!customMsgs[phone]);
      }
    });

    // Textarea change - save custom message and update WhatsApp link
    document.addEventListener('input', function(e) {
      if (e.target.tagName === 'TEXTAREA' && e.target.dataset.phone) {
        const phone = e.target.dataset.phone;
        const contact = contacts.find(c => c.phone === phone);
        const defaultMsg = getDefaultMessage(contact);
        const newMsg = e.target.value;

        if (newMsg === defaultMsg) {
          delete customMsgs[phone];
          saveToSupabase(phone, undefined, '');
        } else {
          customMsgs[phone] = newMsg;
          // Debounced save
          clearTimeout(e.target._saveTimeout);
          e.target._saveTimeout = setTimeout(() => saveToSupabase(phone, undefined, newMsg), 800);
        }

        // Update the WhatsApp link immediately
        const row = e.target.closest('.contact');
        const waBtn = row.querySelector('.whatsapp-btn');
        const cleanPhone = phone.replace(/[a-z]$/i, '');
        waBtn.href = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(newMsg)}`;

        // Update label
        const label = row.querySelector('.editor-actions small');
        label.textContent = newMsg === defaultMsg ? 'Default template' : 'Custom message';
      }
    });

    // Reset to default message
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('reset-msg-btn')) {
        const phone = e.target.dataset.phone;
        const contact = contacts.find(c => c.phone === phone);
        const defaultMsg = getDefaultMessage(contact);
        const editor = document.getElementById('editor-' + phone);
        editor.querySelector('textarea').value = defaultMsg;
        delete customMsgs[phone];
        saveToSupabase(phone, undefined, '');

        // Update WhatsApp link
        const row = editor.closest('.contact');
        const waBtn = row.querySelector('.whatsapp-btn');
        const cleanPhone = phone.replace(/[a-z]$/i, '');
        waBtn.href = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(defaultMsg)}`;

        // Update label and edit button
        editor.querySelector('.editor-actions small').textContent = 'Default template';
        row.querySelector('.edit-btn').classList.remove('active');
      }
    });

    // Reset all
    function resetAll() {
      if (!confirm('Reset all sent markers and custom messages? This cannot be undone.')) return;
      sentMap = {};
      customMsgs = {};
      localStorage.removeItem('wa-sent');
      localStorage.removeItem('wa-msgs');
      // Clear Supabase
      sbFetch('outreach_contacts', { method: 'DELETE', headers: { 'Prefer': '' } })
        .then(() => sbFetch('outreach_contacts?sent=eq.true', { method: 'DELETE', headers: { 'Prefer': '' } }))
        .catch(() => {});
      renderContacts(currentFilter);
    }

    // ── Init ──
    (async function init() {
      await loadFromSupabase();
      renderContacts('all');
    })();
    </script>
</body>
</html>
