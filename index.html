<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ringvox Outreach Dashboard</title>
    <link rel="icon" href="https://ringvox.co/images/brand/favicon-32.png" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f13;
            color: #e5e5e5;
            min-height: 100vh;
        }

        /* ── Header ── */
        .header {
            background: linear-gradient(135deg, #18181b 0%, #1a1520 50%, #18181b 100%);
            border-bottom: 1px solid rgba(249,115,22,0.15);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 200;
            backdrop-filter: blur(12px);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-area svg { flex-shrink: 0; }
        .logo-text {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #fb923c, #f97316, #ef4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        .logo-tagline {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .header-divider {
            width: 1px;
            height: 32px;
            background: rgba(255,255,255,0.08);
        }
        .page-title {
            font-size: 15px;
            font-weight: 600;
            color: #d1d5db;
        }
        .page-title span {
            color: #f97316;
        }

        /* ── Stats bar (header) ── */
        .stats-bar {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .stat-pill .num {
            font-size: 18px;
            font-weight: 800;
        }
        .stat-sent .num { color: #22c55e; }
        .stat-total .num { color: #f97316; }
        .sync-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .sync-ok { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
        .sync-err { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
        .sync-loading { background: #f97316; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .sync-label { font-size: 10px; color: #6b7280; }

        /* ── Dashboard stats row ── */
        .dashboard-stats {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px 20px 0 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }
        .dash-card {
            background: #1a1a22;
            border: 1px solid #2a2a32;
            border-radius: 10px;
            padding: 14px 12px;
            text-align: center;
            transition: border-color 0.2s;
        }
        .dash-card:hover { border-color: #3a3a44; }
        .dash-card .dash-num {
            font-size: 24px;
            font-weight: 800;
            line-height: 1.1;
        }
        .dash-card .dash-label {
            font-size: 10px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .dash-card.dash-sent .dash-num { background: linear-gradient(135deg, #22c55e, #16a34a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dash-card.dash-rate .dash-num { background: linear-gradient(135deg, #f97316, #ef4444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .dash-card.dash-interested .dash-num { color: #f97316; }
        .dash-card.dash-booked .dash-num { color: #22c55e; }
        .dash-card.dash-signedup .dash-num { color: #8b5cf6; }
        .dash-card.dash-followup .dash-num { color: #fb923c; }

        /* ── Main content ── */
        .main {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ── Controls row ── */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 14px 8px 36px;
            background: #1e1e24;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .search-box:focus { border-color: #f97316; }
        .search-box::placeholder { color: #555; }
        .search-wrap {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        .search-wrap svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #555;
        }

        .filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid #2a2a32;
            background: #1e1e24;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.2s;
            font-family: inherit;
        }
        .filter-btn.active {
            border-color: #f97316;
            background: rgba(249,115,22,0.1);
            color: #f97316;
        }
        .filter-btn:hover { border-color: #f97316; color: #d1d5db; }

        .csv-btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid #2a2a32;
            background: #1e1e24;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .csv-btn:hover { border-color: #22c55e; color: #22c55e; }

        /* ── Batch headers ── */
        .batch-header {
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            margin: 24px 0 8px 0;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.3px;
            position: sticky;
            top: 57px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .batch-header svg { opacity: 0.7; }
        .batch-progress {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
        }
        .batch-progress-bar {
            width: 60px;
            height: 6px;
            background: rgba(255,255,255,0.25);
            border-radius: 3px;
            overflow: hidden;
        }
        .batch-progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* ── Contact cards ── */
        .contact {
            background: #1a1a22;
            border: 1px solid #2a2a32;
            padding: 14px 16px;
            margin: 6px 0;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .contact:hover { border-color: #3a3a44; }
        .contact.sent {
            opacity: 0.35;
            border-color: #1e1e24;
        }
        .contact.sent .whatsapp-btn { background: #333; pointer-events: none; }
        .contact-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sent-check {
            width: 18px; height: 18px;
            cursor: pointer;
            accent-color: #22c55e;
            flex-shrink: 0;
        }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name {
            font-weight: 600;
            font-size: 14px;
            color: #f3f4f6;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .contact-name strong { color: #fb923c; font-weight: 700; }
        .contact-details {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .contact-details a {
            color: #60a5fa;
            text-decoration: none;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        .contact-details a:hover { text-decoration: underline; color: #93bbfc; }

        .trade-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .trade-Plumber { background: rgba(37,99,235,0.15); color: #60a5fa; }
        .trade-Electrician { background: rgba(249,115,22,0.15); color: #fb923c; }
        .trade-Builder { background: rgba(34,197,94,0.15); color: #4ade80; }

        /* ── Status pill ── */
        .status-pill {
            display: inline-flex;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-none { background: rgba(107,114,128,0.15); color: #6b7280; }
        .status-interested { background: rgba(249,115,22,0.15); color: #f97316; }
        .status-call_booked { background: rgba(34,197,94,0.15); color: #22c55e; }
        .status-not_interested { background: rgba(239,68,68,0.15); color: #ef4444; }
        .status-signed_up { background: rgba(139,92,246,0.15); color: #8b5cf6; }

        /* ── Follow-up badge ── */
        .followup-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            background: rgba(251,146,60,0.2);
            color: #fb923c;
            animation: pulse 2s infinite;
        }

        .contact-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }
        .whatsapp-btn:hover { background: #20BA5A; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,211,102,0.3); }
        .edit-btn {
            background: transparent;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            padding: 7px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s;
            line-height: 1;
        }
        .edit-btn:hover { border-color: #f97316; color: #f97316; }
        .edit-btn.active { border-color: #f97316; color: #f97316; background: rgba(249,115,22,0.08); }

        /* ── Edit panel (message editor + response controls + notes) ── */
        .edit-panel {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2a2a32;
        }
        .edit-panel.open { display: block; }

        .edit-panel-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        .edit-panel-controls label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .response-select {
            padding: 5px 10px;
            background: #12121a;
            border: 1px solid #2a2a32;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 12px;
            font-family: inherit;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .response-select:focus { border-color: #f97316; }
        .followup-input {
            padding: 5px 10px;
            background: #12121a;
            border: 1px solid #2a2a32;
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 12px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .followup-input:focus { border-color: #f97316; }
        .followup-input::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
        }

        .wa-format-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        .wa-format-bar button {
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid #2a2a32;
            background: #1e1e24;
            color: #9ca3af;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .wa-format-bar button:hover {
            background: #2a2a32;
            color: #f97316;
            border-color: #f97316;
        }
        .wa-format-bar .fmt-bold { font-weight: 700; }
        .wa-format-bar .fmt-italic { font-style: italic; }
        .wa-format-bar .fmt-strike { text-decoration: line-through; }
        .wa-format-bar .fmt-mono { font-family: monospace; letter-spacing: 0.5px; }
        .wa-format-hint {
            font-size: 10px;
            color: #6b7280;
            margin-left: auto;
            align-self: center;
        }
        .message-editor textarea {
            width: 100%;
            min-height: 180px;
            padding: 12px;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            color: #e5e5e5;
            background: #12121a;
            outline: none;
            transition: border-color 0.2s;
        }
        .message-editor textarea:focus { border-color: #f97316; }
        .editor-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }
        .editor-actions small { color: #6b7280; font-size: 11px; }
        .editor-actions small.custom { color: #f97316; }
        .reset-msg-btn {
            font-size: 11px;
            color: #6b7280;
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            font-family: inherit;
        }
        .reset-msg-btn:hover { color: #ef4444; }

        /* ── Conversation notes ── */
        .notes-section {
            margin-top: 12px;
        }
        .notes-section label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: block;
            margin-bottom: 6px;
        }
        .notes-textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            font-family: inherit;
            font-size: 12px;
            line-height: 1.5;
            resize: vertical;
            color: #e5e5e5;
            background: #12121a;
            outline: none;
            transition: border-color 0.2s;
        }
        .notes-textarea:focus { border-color: #f97316; }
        .notes-textarea::placeholder { color: #4b5563; }

        /* ── Reply templates ── */
        .reply-templates-btn {
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid rgba(249,115,22,0.3);
            background: rgba(249,115,22,0.08);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #f97316;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .reply-templates-btn:hover { background: rgba(249,115,22,0.15); border-color: #f97316; }
        .reply-templates-panel {
            display: none;
            margin-top: 10px;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            background: #12121a;
            overflow: hidden;
        }
        .reply-templates-panel.open { display: block; }
        .reply-template-item {
            padding: 10px 14px;
            border-bottom: 1px solid #2a2a32;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        .reply-template-item:last-child { border-bottom: none; }
        .reply-template-label {
            font-size: 11px;
            font-weight: 700;
            color: #f97316;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .reply-template-text {
            font-size: 12px;
            color: #d1d5db;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .reply-copy-btn {
            padding: 4px 10px;
            border-radius: 5px;
            border: 1px solid #2a2a32;
            background: #1e1e24;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            color: #9ca3af;
            transition: all 0.2s;
            font-family: inherit;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .reply-copy-btn:hover { border-color: #22c55e; color: #22c55e; }
        .reply-copy-btn.copied { border-color: #22c55e; color: #22c55e; }

        /* ── Reset button ── */
        .reset-all-btn {
            font-size: 10px;
            color: #4b5563;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .reset-all-btn:hover { color: #ef4444; }

        /* ── Login gate ── */
        .login-gate {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0f0f13;
        }
        .login-box {
            background: #1a1a22;
            border: 1px solid #2a2a32;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 380px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .login-box .logo-text { font-size: 28px; margin-bottom: 4px; }
        .login-box .logo-tagline { margin-bottom: 24px; }
        .login-box p { font-size: 13px; color: #6b7280; margin-bottom: 16px; }
        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: #12121a;
            border: 1px solid #2a2a32;
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 15px;
            font-family: inherit;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 12px;
        }
        .login-input:focus { border-color: #f97316; }
        .login-input::placeholder { color: #4b5563; }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }
        .login-btn:hover { opacity: 0.9; }
        .login-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }
        .app-content { display: none; }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 640px) {
            .header { flex-direction: column; gap: 10px; padding: 12px 16px; }
            .stats-bar { width: 100%; justify-content: center; }
            .header-divider { display: none; }
            .main { padding: 12px; }
            .dashboard-stats { padding: 12px 12px 0 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .contact-row { flex-wrap: wrap; }
            .contact-actions { width: 100%; justify-content: flex-end; margin-top: 8px; }
            .login-box { margin: 20px; padding: 30px 24px; }
            .edit-panel-controls { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- ── Login Gate ── -->
    <div class="login-gate" id="login-gate">
        <div class="login-box">
            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" style="margin-bottom:12px;">
                <defs>
                    <linearGradient id="bg2" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="#f97316"/>
                        <stop offset="50%" stop-color="#f45d2b"/>
                        <stop offset="100%" stop-color="#d946a8"/>
                    </linearGradient>
                </defs>
                <rect x="4" y="18" width="5.5" height="16" rx="2.75" fill="url(#bg2)"/>
                <rect x="13" y="10" width="5.5" height="30" rx="2.75" fill="url(#bg2)"/>
                <rect x="22" y="3" width="5.5" height="42" rx="2.75" fill="url(#bg2)"/>
                <rect x="31" y="13" width="5.5" height="26" rx="2.75" fill="url(#bg2)"/>
                <rect x="40" y="20" width="5.5" height="12" rx="2.75" fill="url(#bg2)"/>
                <path d="M35 6 L36.2 9 L39.2 10.2 L36.2 11.4 L35 14.4 L33.8 11.4 L30.8 10.2 L33.8 9 Z" fill="#f97316" opacity="0.9"/>
                <path d="M42.5 15 L43.1 16.2 L44.5 16.8 L43.1 17.4 L42.5 18.6 L41.9 17.4 L40.5 16.8 L41.9 16.2 Z" fill="#fdba74" opacity="0.6"/>
            </svg>
            <div class="logo-text">Ringvox</div>
            <div class="logo-tagline">AI Voice Agents. Always On.</div>
            <p>Outreach Dashboard</p>
            <input type="password" class="login-input" id="login-password" placeholder="Enter access code" autocomplete="off">
            <button class="login-btn" id="login-btn">Access Dashboard</button>
            <div class="login-error" id="login-error">Wrong access code. Try again.</div>
        </div>
    </div>

    <!-- ── App Content (hidden until authenticated) ── -->
    <div class="app-content" id="app-content">

    <!-- ── Header ── -->
    <div class="header">
        <div class="header-left">
            <div class="logo-area">
                <svg width="36" height="36" viewBox="0 0 48 48" fill="none">
                    <defs>
                        <linearGradient id="bg" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="#f97316"/>
                            <stop offset="50%" stop-color="#f45d2b"/>
                            <stop offset="100%" stop-color="#d946a8"/>
                        </linearGradient>
                    </defs>
                    <rect x="4" y="18" width="5.5" height="16" rx="2.75" fill="url(#bg)"/>
                    <rect x="13" y="10" width="5.5" height="30" rx="2.75" fill="url(#bg)"/>
                    <rect x="22" y="3" width="5.5" height="42" rx="2.75" fill="url(#bg)"/>
                    <rect x="31" y="13" width="5.5" height="26" rx="2.75" fill="url(#bg)"/>
                    <rect x="40" y="20" width="5.5" height="12" rx="2.75" fill="url(#bg)"/>
                    <path d="M35 6 L36.2 9 L39.2 10.2 L36.2 11.4 L35 14.4 L33.8 11.4 L30.8 10.2 L33.8 9 Z" fill="#f97316" opacity="0.9"/>
                    <path d="M42.5 15 L43.1 16.2 L44.5 16.8 L43.1 17.4 L42.5 18.6 L41.9 17.4 L40.5 16.8 L41.9 16.2 Z" fill="#fdba74" opacity="0.6"/>
                </svg>
                <div>
                    <div class="logo-text">Ringvox</div>
                    <div class="logo-tagline">AI Voice Agents. Always On.</div>
                </div>
            </div>
            <div class="header-divider"></div>
            <div class="page-title"><span>WhatsApp</span> Outreach</div>
        </div>
        <div class="stats-bar">
            <div class="stat-pill stat-sent">
                <span class="num" id="sent-count">0</span>
                <span>sent</span>
            </div>
            <div class="stat-pill stat-total">
                <span class="num" id="total-shown">200</span>
                <span>contacts</span>
            </div>
            <div style="display:flex;align-items:center;gap:5px;">
                <span class="sync-dot sync-loading" id="sync-dot"></span>
                <span class="sync-label" id="sync-label">syncing</span>
            </div>
            <button class="reset-all-btn" onclick="resetAll()">reset all</button>
        </div>
    </div>

    <!-- ── Dashboard Stats ── -->
    <div class="dashboard-stats">
        <div class="stats-grid">
            <div class="dash-card dash-sent">
                <div class="dash-num" id="dash-sent">0</div>
                <div class="dash-label">Total Sent</div>
            </div>
            <div class="dash-card dash-rate">
                <div class="dash-num" id="dash-rate">0%</div>
                <div class="dash-label">Response Rate</div>
            </div>
            <div class="dash-card dash-interested">
                <div class="dash-num" id="dash-interested">0</div>
                <div class="dash-label">Interested</div>
            </div>
            <div class="dash-card dash-booked">
                <div class="dash-num" id="dash-booked">0</div>
                <div class="dash-label">Calls Booked</div>
            </div>
            <div class="dash-card dash-signedup">
                <div class="dash-num" id="dash-signedup">0</div>
                <div class="dash-label">Signed Up</div>
            </div>
            <div class="dash-card dash-followup">
                <div class="dash-num" id="dash-followup">0</div>
                <div class="dash-label">Follow-ups Due</div>
            </div>
        </div>
    </div>

    <!-- ── Main ── -->
    <div class="main">
        <div class="controls">
            <div class="search-wrap">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input type="text" class="search-box" id="search" placeholder="Search by name, city, or phone...">
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="Plumber">Plumbers</button>
                <button class="filter-btn" data-filter="Electrician">Electricians</button>
                <button class="filter-btn" data-filter="Builder">Builders</button>
                <button class="filter-btn" data-filter="followup">Follow-ups Due</button>
            </div>
            <button class="csv-btn" onclick="exportCSV()">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export CSV
            </button>
        </div>

        <div id="contacts-container"></div>
    </div>

    <script>
    // ── Supabase ──
    const SB_URL = 'https://nantnllmvftqmrwjorqe.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hbnRubGxtdmZ0cW1yd2pvcnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzMzQyOTYsImV4cCI6MjA4NjkxMDI5Nn0.os0CptUMkUxRXLm3_EsJq9GimwGKtUSNZ9hiQ7cLNsU';

    async function sbFetch(path, opts = {}) {
      const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
        ...opts,
        headers: {
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation',
          ...(opts.headers || {})
        }
      });
      if (!res.ok) throw new Error(`Supabase ${res.status}`);
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    // ── Contacts ──
    const contacts = [
      {name:"Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871660582",dp:"0871660582",fn:"",web:"https://aturnerplumbing.ie/"},
      {name:"Pat Kelleher Plumbing",trade:"Plumber",city:"Cork",phone:"353879730364",dp:"0879730364",fn:"Pat",web:"https://www.kelleherplumbing.ie/"},
      {name:"Emergency Plumber Cork",trade:"Plumber",city:"Cork",phone:"353871345062",dp:"0871345062",fn:"",web:"https://gaselectricalservices.ie/emergency-call-out/"},
      {name:"Tony Leahy Heating & Plumbing",trade:"Plumber",city:"Cork",phone:"353879223332",dp:"0879223332",fn:"Tony",web:"http://www.tonyleahyheatingandplumbingservices.ie/"},
      {name:"Plumbing Maintenance and Call",trade:"Plumber",city:"Cork",phone:"353879470505",dp:"0879470505",fn:"",web:"https://crowleyplumbing.ie/plumbing-services/plumbing-maintenance-and-call-outs/"},
      {name:"Cork Enterprise Plumbing",trade:"Plumber",city:"Cork",phone:"353878507445",dp:"0878507445",fn:"",web:"https://www.corkenterpriseplumbing.com/"},
      {name:"Plumbers Cork County",trade:"Plumber",city:"Cork",phone:"353873955256",dp:"0873955256",fn:"",web:"https://www.goldenpages.ie/plumbers/cork-county/"},
      {name:"Cork Electrician",trade:"Electrician",city:"Cork",phone:"353868131570",dp:"0868131570",fn:"",web:"https://corkelectricianslimited.ie/"},
      {name:"Electricians Cork County",trade:"Electrician",city:"Cork",phone:"353862538477",dp:"0862538477",fn:"",web:"https://www.goldenpages.ie/electricians/cork-county/"},
      {name:"Electrician Cork",trade:"Electrician",city:"Cork",phone:"353877464011",dp:"0877464011",fn:"",web:"https://corkelectrical.ie/"},
      {name:"Electricians in Cork",trade:"Electrician",city:"Cork",phone:"353862563322",dp:"0862563322",fn:"",web:"https://www.hotfrog.ie/find/electricians/cork"},
      {name:"Small Builders Cork",trade:"Builder",city:"Cork",phone:"353874656330",dp:"0874656330",fn:"",web:"https://www.forgedconstruction.ie/"},
      {name:"Chris O'Donovan Construction",trade:"Builder",city:"Cork",phone:"353872335198",dp:"0872335198",fn:"Chris",web:"http://chrisodonovanconstruction.com/"},
      {name:"Builder Cork",trade:"Builder",city:"Cork",phone:"353872925951",dp:"0872925951",fn:"",web:"https://murtyosullivanbuilders.ie/"},
      {name:"Builders in Cork",trade:"Builder",city:"Cork",phone:"353872360514",dp:"+353872360514",fn:"",web:"https://www.constructionireland.ie/d_s/1,-1/cork/builders"},
      {name:"DKS Construction",trade:"Builder",city:"Cork",phone:"353876807226",dp:"0876807226",fn:"",web:"https://www.dksconstruction.ie/"},
      {name:"Building Contractors Cork",trade:"Builder",city:"Cork",phone:"353214859032",dp:"0214859032",fn:"",web:"https://chamber.corkchamber.ie/list/category/building-contractors-providers-10"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863579495",dp:"0863579495",fn:"",web:"https://plumber-dublin.ie/"},
      {name:"24 Hour Plumber",trade:"Plumber",city:"Dublin",phone:"353858556111",dp:"0858556111",fn:"",web:"https://www.24hourplumber.ie"},
      {name:"Plumbers Dublin County",trade:"Plumber",city:"Dublin",phone:"353862345954",dp:"0862345954",fn:"",web:"https://www.goldenpages.ie/plumbers/dublin-dublin-county/"},
      {name:"The Dublin Plumber",trade:"Plumber",city:"Dublin",phone:"353858667631",dp:"0858667631",fn:"",web:"https://www.thedublinplumber.ie/"},
      {name:"Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353863748000",dp:"0863748000",fn:"",web:"https://dublinplumber24hrs.ie/"},
      {name:"Plumber Dublin 24/7",trade:"Plumber",city:"Dublin",phone:"35314851554",dp:"014851554",fn:"",web:"https://plumbers247.net/"},
      {name:"Plumber Dublin 12",trade:"Plumber",city:"Dublin",phone:"35315143300",dp:"015143300",fn:"",web:"https://www.dewarplumbers.ie/plumber-dublin-12.html"},
      {name:"Kieron Murphy Plumbing",trade:"Plumber",city:"Dublin",phone:"353872768007",dp:"0872768007",fn:"Kieron",web:"https://plumbingheating.ie/"},
      {name:"RapidPlumb",trade:"Plumber",city:"Dublin",phone:"353851054991",dp:"0851054991",fn:"",web:"https://www.rapidplumb.ie/"},
      {name:"Emergency Plumber Dublin",trade:"Plumber",city:"Dublin",phone:"353866049361",dp:"0866049361",fn:"",web:"https://www.sidsplumbing.ie/"},
      {name:"Dublin Plumbing",trade:"Plumber",city:"Dublin",phone:"35315354268",dp:"015354268",fn:"",web:"https://dublinplumbing.ie/contact-us/"},
      {name:"House Rewire Dublin",trade:"Electrician",city:"Dublin",phone:"353858238132",dp:"0858238132",fn:"",web:"https://dublin-electricians.ie/"},
      {name:"Mobile Auto Electrician Dublin",trade:"Electrician",city:"Dublin",phone:"353852332555",dp:"0852332555",fn:"",web:"https://www.mobileautoelectrician.ie/"},
      {name:"Clontarf Electrician",trade:"Electrician",city:"Dublin",phone:"353862525331",dp:"0862525331",fn:"",web:"https://www.ichristie.com/"},
      {name:"Builders Dublin",trade:"Builder",city:"Dublin",phone:"35314851330",dp:"014851330",fn:"",web:"https://buildersdublin.ie/"},
      {name:"Clancon Build",trade:"Builder",city:"Dublin",phone:"35318904373",dp:"018904373",fn:"",web:"https://clancon.ie/"},
      {name:"BuildMe Dublin",trade:"Builder",city:"Dublin",phone:"35312709051",dp:"012709051",fn:"",web:"https://buildme.ie/"},
      {name:"DS Construction",trade:"Builder",city:"Dublin",phone:"353872265559",dp:"0872265559",fn:"",web:"https://dsconstructionservices.ie/"},
      {name:"Plumber Gas Installer Limerick",trade:"Plumber",city:"Limerick",phone:"353876461132",dp:"0876461132",fn:"",web:"https://www.gaswork.ie/"},
      {name:"Professional Plumbing Limerick",trade:"Plumber",city:"Limerick",phone:"353877647119",dp:"0877647119",fn:"",web:"https://professionalplumbing.ie/"},
      {name:"Plumbing Services Limerick",trade:"Plumber",city:"Limerick",phone:"353838357426",dp:"0838357426",fn:"",web:"https://arconstruction.ie/plumbing-company/"},
      {name:"Pinnacle Group Limerick",trade:"Plumber",city:"Limerick",phone:"353879622222",dp:"0879622222",fn:"",web:"https://pinnaclegroup.ie/plumbers-in-limerick/"},
      {name:"KJ Electrical Limerick",trade:"Electrician",city:"Limerick",phone:"353877489102",dp:"0877489102",fn:"",web:"https://www.kjelectrical.ie/"},
      {name:"Limerick Electricians",trade:"Electrician",city:"Limerick",phone:"353892565413",dp:"0892565413",fn:"",web:"https://www.limerickelectricians.ie/electrical-emergency-limerick/"},
      {name:"Builders Limerick County",trade:"Builder",city:"Limerick",phone:"353876863000",dp:"0876863000",fn:"",web:"https://www.goldenpages.ie/builders/limerick-county/"},
      {name:"Galway Plumbing Solutions",trade:"Plumber",city:"Galway",phone:"353851720646",dp:"0851720646",fn:"",web:"https://www.galwayplumbingsolutions.ie/"},
      {name:"Plumber Galway",trade:"Plumber",city:"Galway",phone:"353896177808",dp:"0896177808",fn:"",web:"https://esda.ie/listing/plumber-galway/"},
      {name:"Heating & Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353863361645",dp:"0863361645",fn:"",web:"https://classifieds.advertiser.ie/services-available/heating-plumbing/"},
      {name:"Galway Plumbing Solutions FB",trade:"Plumber",city:"Galway",phone:"353851720646b",dp:"+353851720646",fn:"",web:"https://www.facebook.com/Galwayplumbingsolutions/"},
      {name:"Emergency Plumbing Galway",trade:"Plumber",city:"Galway",phone:"353833638883",dp:"+353833638883",fn:"",web:"https://galwaypropertyservices.ie/plumbing-service"},
      {name:"PB Gibbons Electrical",trade:"Electrician",city:"Galway",phone:"353874215886",dp:"0874215886",fn:"",web:"https://www.facebook.com/pbgibbonselectricalltd/"},
      {name:"Electrician Galway",trade:"Electrician",city:"Galway",phone:"353877372236",dp:"0877372236",fn:"",web:"http://www.electriciangalway.net/index.php/contact-us/"},
      {name:"MD Electrics",trade:"Electrician",city:"Galway",phone:"353872303388",dp:"0872303388",fn:"",web:"https://mdelectrics.ie/"},
      {name:"Galway Electrical Services",trade:"Electrician",city:"Galway",phone:"353879044167",dp:"0879044167",fn:"",web:"https://www.galwayelectricalservices.ie/"},
      {name:"Moycullen Electrical",trade:"Electrician",city:"Galway",phone:"353879644477",dp:"0879644477",fn:"",web:"https://www.facebook.com/p/Moycullen-Electrical-100070243419698/"},
      {name:"Emergency Electrician Galway",trade:"Electrician",city:"Galway",phone:"353862508743",dp:"0862508743",fn:"",web:"https://www.martinon.ie/pagee371.html?id=18"},
      {name:"Emergency Electricians Galway",trade:"Electrician",city:"Galway",phone:"353838929402",dp:"0838929402",fn:"",web:"https://electrician-galway.ie/"},
      {name:"Electrician in Galway",trade:"Electrician",city:"Galway",phone:"353872224230",dp:"0872224230",fn:"",web:"https://www.hotfrog.ie/search/galway/electrician"},
      {name:"Builders in Galway",trade:"Builder",city:"Galway",phone:"353877375329",dp:"0877375329",fn:"",web:"http://www.fvgconstruction.ie/"},
      {name:"Tom Noone Construction",trade:"Builder",city:"Galway",phone:"353879517022",dp:"+353879517022",fn:"Tom",web:"https://www.facebook.com/p/Tom-Noone-Construction-Ltd-100063467171741/"},
      {name:"DR Heating Plumbing Waterford",trade:"Plumber",city:"Waterford",phone:"353858680890",dp:"0858680890",fn:"",web:"https://www.drheatingplumbing.com/"},
      {name:"Joe Waller Plumbing",trade:"Plumber",city:"Waterford",phone:"353872456184",dp:"0872456184",fn:"",web:"https://joewallerplumbing.ie/"},
      {name:"James Melay Electrical",trade:"Electrician",city:"Waterford",phone:"353872387119",dp:"0872387119",fn:"James",web:"https://about.me/jamesmelay"},
      {name:"Hickeys Plumbing",trade:"Plumber",city:"Cork",phone:"353872935996",dp:"0872935996",fn:"",web:"https://hickeysplumbing.ie/"},
      {name:"General Plumbing Cork",trade:"Plumber",city:"Cork",phone:"353866642391",dp:"0866642391",fn:"",web:"https://aturnerplumbing.ie/general-plumbing/"},
      {name:"O'Brien Plumbing & Heating",trade:"Plumber",city:"Cork",phone:"353871234567",dp:"0871234567",fn:"",web:"https://trades.connecteire.ie/"},
      {name:"Plumbers Cork",trade:"Plumber",city:"Cork",phone:"353876740965",dp:"0876740965",fn:"",web:"http://www.findaplumber.ie/corkplumbers.html"},
      {name:"Cork Plumbing Services",trade:"Plumber",city:"Cork",phone:"353873592245",dp:"0873592245",fn:"",web:"https://www.corkplumbingservices.com/"},
      {name:"Electrician Dublin 24/7",trade:"Electrician",city:"Dublin",phone:"353871707087",dp:"0871707087",fn:"",web:"https://robbieburkeelectrical.ie/"},
      {name:"AMR Electrical Contractors",trade:"Electrician",city:"Dublin",phone:"353876992788",dp:"+353876992788",fn:"",web:"https://www.amrelectrical.ie/"},
      {name:"24 Hour Emergency Electricians",trade:"Electrician",city:"Dublin",phone:"353877414362",dp:"+353877414362",fn:"",web:"https://www.facebook.com/myelectrician.ie/"},
      {name:"JHBC Galway",trade:"Builder",city:"Galway",phone:"353872887431",dp:"0872887431",fn:"",web:"https://www.jhbc.ie/contact/"},
      {name:"Kildare Plumbing and Heating",trade:"Plumber",city:"Kildare",phone:"353868389326",dp:"0868389326",fn:"",web:"https://esda.ie/listing/kildare-plumbing-and-heating/"},
      {name:"Waterworx Plumbing",trade:"Plumber",city:"Kildare",phone:"353872348469",dp:"0872348469",fn:"",web:"https://www.waterworx.ie/plumbing-services"},
      {name:"Plumber Kildare",trade:"Plumber",city:"Kildare",phone:"353861660883",dp:"0861660883",fn:"",web:""},
      {name:"Electricians Wexford",trade:"Electrician",city:"Wexford",phone:"353866057064",dp:"0866057064",fn:"",web:"http://www.goreyonline.com/electricians.html"},
      {name:"Kevin Moore Building",trade:"Builder",city:"Kilkenny",phone:"353567762602",dp:"0567762602",fn:"Kevin",web:"https://www.kevinmooreltd.com/"},
      {name:"Plumbing & Heating Sligo",trade:"Plumber",city:"Sligo",phone:"353878070352",dp:"0878070352",fn:"",web:"https://plumberandheatingsligo.com/"},
      {name:"Sligo Plumber",trade:"Plumber",city:"Sligo",phone:"353872903690",dp:"0872903690",fn:"",web:"https://sligoplumber.com/contact"},
      {name:"Emergency Plumber Sligo",trade:"Plumber",city:"Sligo",phone:"353873410745",dp:"0873410745",fn:"",web:"https://emergencyplumbersligo.com/"},
      {name:"Plumbers in Sligo",trade:"Plumber",city:"Sligo",phone:"353877085922",dp:"0877085922",fn:"",web:"https://www.constructionireland.ie/d_s/4,-1/sligo/plumbers"},
      {name:"Tom Leydon Plumbing",trade:"Plumber",city:"Sligo",phone:"353878217547",dp:"0878217547",fn:"Tom",web:"https://www.worksy.ie/businesses/ac8ce4b5-29ff-482f-b2c6-2196f7fb6c3c"},
      {name:"AMS Plumbing Sligo",trade:"Plumber",city:"Sligo",phone:"353872414466",dp:"0872414466",fn:"",web:"http://amsplumbing.ie/"},
      {name:"Sligo Plumbers",trade:"Plumber",city:"Sligo",phone:"353879222131",dp:"0879222131",fn:"",web:"https://www.locallife.ie/sligo/plumbers.asp"},
      {name:"Sean Browne Electrical",trade:"Electrician",city:"Mayo",phone:"353872676322",dp:"0872676322",fn:"Sean",web:"https://www.our.ie/county-mayo/claremorris/trades/sean-browne-electrical/browneelectrical/"},
      {name:"Stevie Kiernan Plumbing",trade:"Plumber",city:"Drogheda",phone:"353879019509",dp:"+353879019509",fn:"Stevie",web:"https://www.facebook.com/steviekph/"},
      {name:"EPC Plumbing Drogheda",trade:"Plumber",city:"Drogheda",phone:"353872788522",dp:"0872788522",fn:"",web:"https://www.epcplumbingheating.ie/contacts.htm"},
      {name:"All Out Plumbing & Heating",trade:"Plumber",city:"Drogheda",phone:"353857746691",dp:"+353857746691",fn:"",web:"https://www.facebook.com/Idjfhg/"},
      {name:"Drain Cleaning Drogheda",trade:"Plumber",city:"Drogheda",phone:"353861249070",dp:"0861249070",fn:"",web:"https://dublinplumbingservices.ie/drain-cleaning-services-drogheda-county-louth/"},
      {name:"Torc Electric",trade:"Electrician",city:"Athlone",phone:"353906492449",dp:"0906492449",fn:"",web:"https://www.torcelectric.ie/"},
      {name:"Sean Allen Heating & Plumbing",trade:"Plumber",city:"Tralee",phone:"353838735807",dp:"+353838735807",fn:"Sean",web:"https://www.facebook.com/SALHeating/"},
      {name:"Tralee Plumbers",trade:"Plumber",city:"Tralee",phone:"353667133611",dp:"0667133611",fn:"",web:"https://www.locallife.ie/tralee/plumbers.asp"},
      {name:"Bennis Water Plumbing",trade:"Plumber",city:"Tralee",phone:"353872931673",dp:"0872931673",fn:"",web:"https://esda.ie/listing/bennis-water-plumbing-services/"},
      {name:"GOC Plumbing & Heating",trade:"Plumber",city:"Tralee",phone:"353873331789",dp:"0873331789",fn:"",web:"https://www.gocplumbing.com/"},
      {name:"Fitz Plumbing Clare",trade:"Plumber",city:"Clare",phone:"353876792272",dp:"0876792272",fn:"",web:"https://fitzplumbingandheating.com/"},
      {name:"Electrician Tipperary",trade:"Electrician",city:"Tipperary",phone:"353879924510",dp:"0879924510",fn:"",web:"http://jobel.ie/"},
      {name:"Mark Barrett MEB Services",trade:"Plumber",city:"Carlow",phone:"353872753675",dp:"0872753675",fn:"Mark",web:""},
      {name:"Plumbing Contractor Carlow",trade:"Plumber",city:"Carlow",phone:"353876162614",dp:"0876162614",fn:"",web:""},
      {name:"24hr Emergency Plumber Carlow",trade:"Plumber",city:"Carlow",phone:"353863029355",dp:"0863029355",fn:"",web:""},
      {name:"John Lawlor Plumbing",trade:"Plumber",city:"Carlow",phone:"353879031249",dp:"0879031249",fn:"John",web:""},
      {name:"Pollerton Plumbing",trade:"Plumber",city:"Carlow",phone:"353599139259",dp:"0599139259",fn:"",web:""},
      {name:"Carlow Plumbing Services",trade:"Plumber",city:"Carlow",phone:"353599143460",dp:"0599143460",fn:"",web:""},
      {name:"Paul McGrath Heating & Plumbing",trade:"Plumber",city:"Carlow",phone:"353871234567b",dp:"0871234567",fn:"Paul",web:""},
      // ── Batch 2: 100 new contacts ──
      {name:"Dundalk Plumbing Limited",trade:"Plumber",city:"Dundalk",phone:"353429338111",dp:"0429338111",fn:"",web:"https://esda.ie/listing/dundalk-plumbing-limited/"},
      {name:"Sean Murray Plumbing & Heating",trade:"Plumber",city:"Dundalk",phone:"353879607700",dp:"0879607700",fn:"Sean",web:"https://www.seanmurrayplumbingandheating.ie/"},
      {name:"Dessie O'Hare Plumbing and Heating",trade:"Plumber",city:"Dundalk",phone:"353868478999",dp:"0868478999",fn:"Dessie",web:""},
      {name:"Louth Plumbers Ireland",trade:"Plumber",city:"Dundalk",phone:"353863282904",dp:"0863282904",fn:"",web:"https://louthplumbers.ie/"},
      {name:"RS Plumbing & Heating",trade:"Plumber",city:"Navan",phone:"353868701670",dp:"0868701670",fn:"",web:"https://www.rsplumbingandheating.ie/"},
      {name:"Paul Geoghegan Heating and Plumbing",trade:"Plumber",city:"Navan",phone:"353877546213",dp:"0877546213",fn:"Paul",web:""},
      {name:"Bray Heating and Plumbing",trade:"Plumber",city:"Bray",phone:"353872626382",dp:"0872626382",fn:"Sean",web:"https://www.brayheatingandplumbing.com/"},
      {name:"Jimmy Nangle Plumbing & Gas",trade:"Plumber",city:"Bray",phone:"353879172405",dp:"0879172405",fn:"Jimmy",web:""},
      {name:"Swords Plumbing and Gas",trade:"Plumber",city:"Swords",phone:"353851634408",dp:"0851634408",fn:"",web:"https://swordsplumbingandgas.ie/"},
      {name:"Emergency Plumber Swords",trade:"Plumber",city:"Swords",phone:"353851162474",dp:"0851162474",fn:"",web:"https://www.emergencyplumberswords.ie/"},
      {name:"DS Heating and Plumbing",trade:"Plumber",city:"Wexford",phone:"353863639175",dp:"0863639175",fn:"",web:""},
      {name:"Anthony Ryan Plumbing",trade:"Plumber",city:"Mullingar",phone:"353876633376",dp:"0876633376",fn:"Anthony",web:"http://arplumbing.ie/"},
      {name:"ACD Heating Plumbing and Bathrooms",trade:"Plumber",city:"Mullingar",phone:"353894734240",dp:"0894734240",fn:"Alan",web:"https://acdheatingandbathrooms.com/"},
      {name:"Clavin Plumbing",trade:"Plumber",city:"Mullingar",phone:"353871259971",dp:"0871259971",fn:"",web:""},
      {name:"Kieran Moore Heating & Plumbing",trade:"Plumber",city:"Naas",phone:"353877678238",dp:"0877678238",fn:"Kieran",web:"http://www.mooreheatingplumbing.ie/"},
      {name:"Danny Trundle Heating & Plumbing",trade:"Plumber",city:"Naas",phone:"353458970140",dp:"0458970140",fn:"Danny",web:"https://www.dannytrundle.com/"},
      {name:"Niall Gildea Plumbing & Heating",trade:"Plumber",city:"Letterkenny",phone:"353861718803",dp:"0861718803",fn:"Niall",web:"https://sitelift.site/niallgildeaplumbingheating/"},
      {name:"FS Plumbing & Heating",trade:"Plumber",city:"Letterkenny",phone:"353868517555",dp:"0868517555",fn:"",web:""},
      {name:"SMM Plumbing and Heating",trade:"Plumber",city:"Letterkenny",phone:"353830328311",dp:"0830328311",fn:"",web:"https://smmplumbingandheating.com/"},
      {name:"Mark Torpey Plumbing & Heating",trade:"Plumber",city:"Ennis",phone:"353868119779",dp:"0868119779",fn:"Mark",web:""},
      {name:"Greystones Plumbing",trade:"Plumber",city:"Greystones",phone:"353872570230",dp:"0872570230",fn:"",web:"https://greystonesplumbing.ie/"},
      {name:"BM Plumbing Solutions",trade:"Plumber",city:"Greystones",phone:"353868539367",dp:"0868539367",fn:"",web:"https://www.bmplumbing.ie/"},
      {name:"Eamonn Kearns Plumbing",trade:"Plumber",city:"Greystones",phone:"353872570416",dp:"0872570416",fn:"Eamonn",web:"https://www.ekplumbingheating.ie/"},
      {name:"Lambert Heating and Plumbing",trade:"Plumber",city:"Portlaoise",phone:"353851211244",dp:"0851211244",fn:"Donnacha",web:"https://lambertheatingplumbing.ie/"},
      {name:"A2Z Boiler Services",trade:"Plumber",city:"Portlaoise",phone:"353868917290",dp:"0868917290",fn:"",web:"https://www.a2zboilerservices.ie/"},
      {name:"Colin Rea Plumbing",trade:"Plumber",city:"Mallow",phone:"353879428028",dp:"0879428028",fn:"Colin",web:"https://colinreaplumbing.ie/"},
      {name:"James Cott Plumbing",trade:"Plumber",city:"Mallow",phone:"353876288804",dp:"0876288804",fn:"James",web:""},
      {name:"PlumbTech Midleton",trade:"Plumber",city:"Midleton",phone:"353872944728",dp:"0872944728",fn:"",web:"https://plumbtech.ie/"},
      {name:"DryZone Plumbing Shannon",trade:"Plumber",city:"Shannon",phone:"353879608247",dp:"0879608247",fn:"",web:"https://dryzone.ie/"},
      {name:"MH Plumbing and Heating",trade:"Plumber",city:"Thurles",phone:"353860537193",dp:"0860537193",fn:"",web:"https://www.nakoo.net/mhplumbing/"},
      {name:"D Doran Plumbing & Heating",trade:"Plumber",city:"Arklow",phone:"353871367562",dp:"0871367562",fn:"",web:""},
      {name:"AquaLex Heating & Plumbing",trade:"Plumber",city:"Arklow",phone:"353879833047",dp:"0879833047",fn:"",web:""},
      {name:"Maynooth Plumbers",trade:"Plumber",city:"Maynooth",phone:"353872943904",dp:"0872943904",fn:"",web:"https://www.plumbermaynooth.ie/"},
      {name:"CIK Heating and Plumbing",trade:"Plumber",city:"Celbridge",phone:"353852452973",dp:"0852452973",fn:"Ciaran",web:"https://cikhp.ie/"},
      {name:"James Jordan Plumbing & Heating",trade:"Plumber",city:"Malahide",phone:"353872605595",dp:"0872605595",fn:"James",web:"https://www.jamesjordanplumbingheating.ie/"},
      {name:"DC Heating & Plumbing",trade:"Plumber",city:"Malahide",phone:"353862403706",dp:"0862403706",fn:"",web:""},
      {name:"Kevin Walsh Plumbing & Heating",trade:"Plumber",city:"Youghal",phone:"353863792536",dp:"0863792536",fn:"Kevin",web:"https://youghal.ie/organisation/kevin-walsh-plumbing-heating/"},
      {name:"CL Plumbing Heating Cork",trade:"Plumber",city:"Cork",phone:"353863557235",dp:"0863557235",fn:"Ciaran",web:"https://clplumbing.ie/"},
      {name:"SouthPark Plumbing & Heating",trade:"Plumber",city:"Dublin",phone:"353868100071",dp:"0868100071",fn:"",web:"https://southpark.ie/"},
      {name:"M&F Delta Plumbing",trade:"Plumber",city:"Newbridge",phone:"353454324440",dp:"0454324440",fn:"",web:"https://www.mfdelta.com/"},
      {name:"J Hennessy Plumbing & Heating",trade:"Plumber",city:"Listowel",phone:"353877050265",dp:"0877050265",fn:"",web:""},
      {name:"Gibbons Heating & Plumbing",trade:"Plumber",city:"Cork",phone:"353872559038",dp:"0872559038",fn:"",web:"https://www.corkplumbers.ie/"},
      {name:"Evan White Electrical",trade:"Electrician",city:"Dundalk",phone:"353868926650",dp:"0868926650",fn:"Evan",web:"https://esda.ie/listing/evan-white-electrical/"},
      {name:"Core Electrical Engineering",trade:"Electrician",city:"Navan",phone:"353868618641",dp:"0868618641",fn:"",web:"http://www.coreeng.ie/"},
      {name:"Fix Electrical",trade:"Electrician",city:"Bray",phone:"353831224947",dp:"0831224947",fn:"",web:"https://fixelectrical.ie/"},
      {name:"Maguire Electrical",trade:"Electrician",city:"Bray",phone:"353857364529",dp:"0857364529",fn:"",web:""},
      {name:"McLoughlin Electrical Services",trade:"Electrician",city:"Swords",phone:"353872593208",dp:"0872593208",fn:"",web:"https://www.mcloughlinelectricalservices.ie/"},
      {name:"Applewood Electrical",trade:"Electrician",city:"Swords",phone:"353861741387",dp:"0861741387",fn:"",web:""},
      {name:"Mill View Electrical",trade:"Electrician",city:"Swords",phone:"353868811324",dp:"0868811324",fn:"Oisin",web:""},
      {name:"Watts Up Electric",trade:"Electrician",city:"Naas",phone:"353858207970",dp:"0858207970",fn:"",web:"https://www.wattsupelectric.ie/"},
      {name:"George Cooke GC Electrical",trade:"Electrician",city:"Naas",phone:"353872649113",dp:"0872649113",fn:"George",web:"https://needasparks.com/"},
      {name:"Brendan Murtagh Electrical",trade:"Electrician",city:"Mullingar",phone:"353870570360",dp:"0870570360",fn:"Brendan",web:""},
      {name:"Donegal Electric",trade:"Electrician",city:"Letterkenny",phone:"353851649270",dp:"0851649270",fn:"",web:"https://donegalelectric.eu/"},
      {name:"O'Hara & Harrison Electrical",trade:"Electrician",city:"Letterkenny",phone:"353878142415",dp:"0878142415",fn:"",web:"https://oharaharrison.com/"},
      {name:"P O'Dwyer Electrical Services",trade:"Electrician",city:"Clonmel",phone:"353878395708",dp:"0878395708",fn:"",web:"https://podwyerelectrical.ie/"},
      {name:"EF Electrical & Solar",trade:"Electrician",city:"Clonmel",phone:"353873122231",dp:"0873122231",fn:"",web:"https://www.efelectrical.ie/"},
      {name:"Pine Grove Electrician Ennis",trade:"Electrician",city:"Ennis",phone:"353877812412",dp:"0877812412",fn:"",web:""},
      {name:"Cuirt An Feile Electrician",trade:"Electrician",city:"Ennis",phone:"353863738719",dp:"0863738719",fn:"",web:""},
      {name:"Brian Whelan Electrical",trade:"Electrician",city:"Dungarvan",phone:"353868112775",dp:"0868112775",fn:"Brian",web:""},
      {name:"Platinum Electric",trade:"Electrician",city:"Greystones",phone:"353873224150",dp:"0873224150",fn:"",web:""},
      {name:"M&C Doyle Electrical",trade:"Electrician",city:"Greystones",phone:"353868700113",dp:"0868700113",fn:"",web:"https://mcdoyleelectrical.ie/"},
      {name:"Shane Donoher Electrical",trade:"Electrician",city:"Portlaoise",phone:"353851446905",dp:"0851446905",fn:"Shane",web:""},
      {name:"Dublin Electrician North",trade:"Electrician",city:"Dublin",phone:"353894704490",dp:"0894704490",fn:"",web:""},
      {name:"Dickies Electrical",trade:"Electrician",city:"Malahide",phone:"353892214676",dp:"0892214676",fn:"",web:"https://dickieselectrical.com/"},
      {name:"ArkElEnCo Electrical",trade:"Electrician",city:"Arklow",phone:"353862466678",dp:"0862466678",fn:"",web:"https://www.arkelenco.ie/"},
      {name:"Swift Electrical",trade:"Electrician",city:"Newbridge",phone:"353851220345",dp:"0851220345",fn:"",web:"https://www.swiftelectrical.ie/"},
      {name:"Elite Electrical Newbridge",trade:"Electrician",city:"Newbridge",phone:"353872317730",dp:"0872317730",fn:"",web:"https://eliteelectrical.ie/"},
      {name:"Electrician Cork City",trade:"Electrician",city:"Cork",phone:"353871674094",dp:"0871674094",fn:"",web:"https://www.electriciancork.net/"},
      {name:"021 Electrician Midleton",trade:"Electrician",city:"Midleton",phone:"353212032111",dp:"0212032111",fn:"",web:"https://021electrician.com/"},
      {name:"Dermot Byrne Electrical",trade:"Electrician",city:"Limerick",phone:"353862579837",dp:"0862579837",fn:"Dermot",web:"https://www.limerickelectrician.ie/"},
      {name:"Dave Electrician Galway",trade:"Electrician",city:"Galway",phone:"353860714057",dp:"0860714057",fn:"Dave",web:""},
      {name:"Killarney Electrician",trade:"Electrician",city:"Killarney",phone:"353874681354",dp:"0874681354",fn:"",web:""},
      {name:"Eoin O'Callaghan Electrical",trade:"Electrician",city:"Mallow",phone:"353861697381",dp:"0861697381",fn:"Eoin",web:""},
      {name:"Hepburn Electrical",trade:"Electrician",city:"Cobh",phone:"353831068306",dp:"0831068306",fn:"",web:""},
      {name:"RECI Electrician Cobh",trade:"Electrician",city:"Cobh",phone:"353872505911",dp:"0872505911",fn:"",web:""},
      {name:"Trifolium Construction",trade:"Builder",city:"Dundalk",phone:"353872472732",dp:"0872472732",fn:"Aidan",web:"http://trifoliumconstruction.ie/"},
      {name:"Arrowsmith Construction",trade:"Builder",city:"Dundalk",phone:"353429351472",dp:"0429351472",fn:"",web:"https://www.arrowsmithconstruction.ie/"},
      {name:"Steven Cleary Carpentry",trade:"Builder",city:"Navan",phone:"353862448792",dp:"0862448792",fn:"Steven",web:"https://clearycarpentry.ie/"},
      {name:"Ciaran Conneely Construction",trade:"Builder",city:"Mullingar",phone:"353878346843",dp:"0878346843",fn:"Ciaran",web:"http://www.ciaranconneely.construction/"},
      {name:"Morrissey Construction",trade:"Builder",city:"Clonmel",phone:"353862527244",dp:"0862527244",fn:"",web:"https://www.morrisseyconstruction.ie/"},
      {name:"Leahy Building Contractors",trade:"Builder",city:"Midleton",phone:"353879114398",dp:"0879114398",fn:"",web:"http://www.leahybuildingcontractors.ie/"},
      {name:"Newood Homes",trade:"Builder",city:"Newbridge",phone:"353864029538",dp:"0864029538",fn:"",web:"http://www.newood.ie/"},
      {name:"Home-Rise Construction",trade:"Builder",city:"Naas",phone:"353872526177",dp:"0872526177",fn:"",web:"https://www.homerise.ie/"},
      {name:"Portlaoise Construction Company",trade:"Builder",city:"Portlaoise",phone:"353578620599",dp:"0578620599",fn:"",web:""},
      {name:"Flavin Construction",trade:"Builder",city:"Dungarvan",phone:"353876785247",dp:"0876785247",fn:"",web:""},
      {name:"Evans & Kelliher Construction",trade:"Builder",city:"Killarney",phone:"353669765722",dp:"0669765722",fn:"",web:"https://evansandkelliherconstruction.ie/"},
      {name:"Branton Construction",trade:"Builder",city:"Naas",phone:"353458636230",dp:"0458636230",fn:"",web:"https://www.brantonconstruction.ie/"},
      {name:"Cosier Homes",trade:"Builder",city:"Galway",phone:"353915778860",dp:"0915778860",fn:"Tom",web:"https://www.cosierhomes.ie/"},
      {name:"McNamara Construction",trade:"Builder",city:"Galway",phone:"353917763190",dp:"0917763190",fn:"",web:"https://www.mcnamaraconstruction.ie/"},
      {name:"The Southern Builder",trade:"Builder",city:"Cork",phone:"353871752270",dp:"0871752270",fn:"",web:"https://www.thesouthernbuilder.com/"},
      {name:"Gaughan Construction",trade:"Builder",city:"Castlebar",phone:"353879474660",dp:"0879474660",fn:"Tony",web:"https://gaughanconstruction.ie/"},
      {name:"GDC Construction",trade:"Builder",city:"Letterkenny",phone:"353749160735",dp:"0749160735",fn:"",web:"https://gdcirl.com/"},
      {name:"Griffin Builders Limerick",trade:"Builder",city:"Limerick",phone:"353872559030",dp:"0872559030",fn:"",web:"https://www.griffinbuilderslimerick.ie/"},
      {name:"Handyman Dublin",trade:"Builder",city:"Dublin",phone:"353872806299",dp:"0872806299",fn:"",web:"https://thehandymandublin.com/"},
      {name:"Forged Construction Cork",trade:"Builder",city:"Cork",phone:"353874651330",dp:"0874651330",fn:"",web:"https://www.forgedconstruction.ie/"},
      {name:"S O'Brien & Sons Builders",trade:"Builder",city:"Castlebar",phone:"353949022877",dp:"0949022877",fn:"",web:"https://www.sobrienbuilders.ie/"},
      {name:"NS Construction Ennis",trade:"Builder",city:"Ennis",phone:"353876608247",dp:"0876608247",fn:"Quinton",web:"https://www.nsconstruction.ie/"},
      {name:"ACE Electrical Mayo",trade:"Electrician",city:"Castlebar",phone:"353876123769",dp:"0876123769",fn:"Donal",web:"https://www.aceelectrical.ie/"},
      {name:"KHCL Construction",trade:"Builder",city:"Arklow",phone:"353402269110",dp:"0402269110",fn:"",web:"http://khclconstruction.ie/"},
      {name:"Maurice Walsh Plumbing",trade:"Plumber",city:"Clonmel",phone:"353873669940",dp:"0873669940",fn:"Maurice",web:"https://www.mauricewalshplumbing.ie/"}
    ];

    // ── Message templates ──
    // Real business names extracted from each contact's website
    const businessNames = {
      "353871660582": "A Turner Plumbing",
      "353871345062": "Gas Electrical Services",
      "353879470505": "Crowley Plumbing",
      "353868131570": "Cork Electricians",
      "353877464011": "Cork Electrical",
      "353874656330": "Forged Construction",
      "353872925951": "Murty O'Sullivan Builders",
      "353863748000": "Dublin Plumber 24hrs",
      "35314851554": "Plumbers 247",
      "35315143300": "Dewar Plumbers",
      "353866049361": "Sid's Plumbing",
      "353858238132": "Dublin Electricians",
      "353862525331": "Christie Electrical",
      "353876461132": "Gaswork",
      "353838357426": "AR Construction",
      "353833638883": "Galway Property Services",
      "353862508743": "Martinon Electrical",
      "353838929402": "Electrician Galway",
      "353877375329": "FVG Construction",
      "353858680890": "DR Heating & Plumbing",
      "353866642391": "A Turner Plumbing",
      "353871707087": "Robbie Burke Electrical",
      "353877414362": "My Electrician",
      "353872788522": "EPC Plumbing & Heating",
      "353861249070": "Dublin Plumbing Services",
      "353876792272": "Fitz Plumbing & Heating",
      "353879924510": "Jobel Electrical"
    };

    function getBusinessName(c) {
      // If we have a manually mapped business name, use it
      if (businessNames[c.phone]) return businessNames[c.phone];
      // If the name already looks like a real business (not a generic scraped title), use it
      const generic = /^(plumber|plumbing|electrician|electricians|builder|builders|building|emergency|24 hour|24hr|small|house rewire|mobile auto|heating &|drain cleaning|general plumbing)\b/i;
      const directory = /\b(goldenpages|hotfrog|constructionireland|findaplumber|goreyonline|locallife|esda\.ie|classifieds|chamber\.cork)/i;
      if (directory.test(c.web)) return null;
      if (generic.test(c.name) && !businessNames[c.phone]) return null;
      return c.name;
    }

    function getDefaultMessage(c) {
      const bn = getBusinessName(c);
      const g = c.fn ? `Hi ${c.fn}` : (bn ? `Hi ${bn}` : `Hi`);
      const t = {
        Plumber: `${g}, Colm here from Ringvox in Limerick.\n\n*Do you miss calls when you're on site?* Most callers won't leave a voicemail, they just ring the next plumber on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\n\u20ac25/month this week (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Electrician: `${g}, Colm here from Ringvox in Limerick.\n\n*Do you miss calls when you're on site?* Most callers won't leave a voicemail, they just ring the next sparky on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\n\u20ac25/month this week (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`,
        Builder: `${g}, Colm here from Ringvox in Limerick.\n\n*Do you miss calls when you're on site?* Most callers won't leave a voicemail, they just ring the next builder on Google.\n\nRingvox answers for you, gets their details, so they're waiting for your callback instead of calling someone else.\n\n\u20ac25/month this week (normally \u20ac49). Full refund if it doesn't catch you a job in 30 days.\n\nWant to try it? I can have you set up by Wednesday.\n\nringvox.co/trades\n\nCheers, Colm`
      };
      return t[c.trade] || t.Plumber;
    }

    // ── Reply templates for follow-up conversations ──
    const replyTemplates = [
      {
        label: '"Tell me more" response',
        text: `Great question! Ringvox is an AI phone agent that answers your calls when you can't.\n\nIt sounds just like a real receptionist - takes the caller's name, number, and what they need. Then texts you the summary instantly so you can call them back.\n\nNo more missed jobs going to the competition. Want me to set you up with a free trial?`
      },
      {
        label: '"How much?" response',
        text: `It's \u20ac25/month for the launch price (normally \u20ac49). That covers unlimited calls answered 24/7.\n\nPlus there's a 30-day money-back guarantee - if it doesn't catch you at least one job, full refund, no questions.\n\nWant to give it a go?`
      },
      {
        label: '"How does it work?" response',
        text: `Dead simple - takes about 5 minutes to set up:\n\n1. You set your phone to divert to Ringvox when you're busy/on site\n2. Ringvox answers as your business ("Hello, [Your Business], how can I help?")\n3. Gets the caller's details and what they need\n4. Texts you the summary straight away\n5. You call them back when you're free\n\nThe caller thinks they spoke to your receptionist. Want me to get you started?`
      },
      {
        label: '"Not interested" graceful close',
        text: `No worries at all! If you ever change your mind or want to give it a try, the offer's there.\n\nBest of luck with the business. Cheers!`
      },
      {
        label: '"Book a call" response',
        text: `Brilliant! I'd love to walk you through it.\n\nWould tomorrow or Thursday work better for a quick 10-minute call? I'll show you exactly how it works and get you set up on the spot.\n\nWhat time suits you best?`
      }
    ];

    // ── State ──
    let sentMap = {};
    let customMsgs = {};
    let responseStatusMap = {};
    let followUpDateMap = {};
    let conversationNotesMap = {};
    let currentFilter = 'all';
    let searchTerm = '';

    // ── Status helpers ──
    const STATUS_LABELS = {
      '': 'No reply',
      'interested': 'Interested',
      'call_booked': 'Call booked',
      'not_interested': 'Not interested',
      'signed_up': 'Signed up'
    };

    function isFollowUpDue(phone) {
      const d = followUpDateMap[phone];
      if (!d) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      const fDate = new Date(d + 'T00:00:00');
      return fDate <= today;
    }

    function getFollowUpsDueCount() {
      return contacts.filter(c => isFollowUpDue(c.phone)).length;
    }

    // ── Supabase sync ──
    async function loadFromSupabase() {
      try {
        const rows = await sbFetch('outreach_contacts?select=phone,sent,notes,response_status,follow_up_date,conversation_notes');
        rows.forEach(r => {
          if (r.sent) sentMap[r.phone] = true;
          if (r.notes) customMsgs[r.phone] = r.notes;
          if (r.response_status) responseStatusMap[r.phone] = r.response_status;
          if (r.follow_up_date) followUpDateMap[r.phone] = r.follow_up_date;
          if (r.conversation_notes) conversationNotesMap[r.phone] = r.conversation_notes;
        });
        setSync(true);
      } catch (e) {
        console.error('Load failed:', e);
        sentMap = JSON.parse(localStorage.getItem('wa-sent') || '{}');
        customMsgs = JSON.parse(localStorage.getItem('wa-msgs') || '{}');
        responseStatusMap = JSON.parse(localStorage.getItem('wa-status') || '{}');
        followUpDateMap = JSON.parse(localStorage.getItem('wa-followup') || '{}');
        conversationNotesMap = JSON.parse(localStorage.getItem('wa-notes') || '{}');
        setSync(false);
      }
    }

    async function saveToSupabase(phone, fields) {
      // Update local state and localStorage
      if (fields.sent !== undefined) {
        if (fields.sent) sentMap[phone] = true; else delete sentMap[phone];
        localStorage.setItem('wa-sent', JSON.stringify(sentMap));
      }
      if (fields.notes !== undefined) {
        if (fields.notes) customMsgs[phone] = fields.notes; else delete customMsgs[phone];
        localStorage.setItem('wa-msgs', JSON.stringify(customMsgs));
      }
      if (fields.response_status !== undefined) {
        if (fields.response_status) responseStatusMap[phone] = fields.response_status; else delete responseStatusMap[phone];
        localStorage.setItem('wa-status', JSON.stringify(responseStatusMap));
      }
      if (fields.follow_up_date !== undefined) {
        if (fields.follow_up_date) followUpDateMap[phone] = fields.follow_up_date; else delete followUpDateMap[phone];
        localStorage.setItem('wa-followup', JSON.stringify(followUpDateMap));
      }
      if (fields.conversation_notes !== undefined) {
        if (fields.conversation_notes) conversationNotesMap[phone] = fields.conversation_notes; else delete conversationNotesMap[phone];
        localStorage.setItem('wa-notes', JSON.stringify(conversationNotesMap));
      }

      try {
        const body = { phone, updated_at: new Date().toISOString() };
        if (fields.sent !== undefined) { body.sent = !!fields.sent; body.sent_at = fields.sent ? new Date().toISOString() : null; }
        if (fields.notes !== undefined) body.notes = fields.notes || null;
        if (fields.response_status !== undefined) body.response_status = fields.response_status || null;
        if (fields.follow_up_date !== undefined) body.follow_up_date = fields.follow_up_date || null;
        if (fields.conversation_notes !== undefined) body.conversation_notes = fields.conversation_notes || null;
        await sbFetch('outreach_contacts', {
          method: 'POST',
          headers: { 'Prefer': 'return=representation,resolution=merge-duplicates' },
          body: JSON.stringify(body)
        });
      } catch (e) {
        console.error('Save failed:', e);
        setSync(false);
      }
    }

    function setSync(ok) {
      const dot = document.getElementById('sync-dot');
      const lbl = document.getElementById('sync-label');
      dot.className = 'sync-dot ' + (ok ? 'sync-ok' : 'sync-err');
      lbl.textContent = ok ? 'synced' : 'offline';
    }

    // ── Helpers ──
    function getSentCount() { return Object.values(sentMap).filter(Boolean).length; }
    function updateCounter() { document.getElementById('sent-count').textContent = getSentCount(); }
    function getMsg(c) { return customMsgs[c.phone] || getDefaultMessage(c); }
    function waLink(c) {
      const p = c.phone.replace(/[a-z]$/i, '');
      return `https://wa.me/${p}?text=${encodeURIComponent(getMsg(c))}`;
    }

    // ── Dashboard stats ──
    function updateDashboard() {
      const sentCount = getSentCount();
      const interested = Object.values(responseStatusMap).filter(s => s === 'interested').length;
      const booked = Object.values(responseStatusMap).filter(s => s === 'call_booked').length;
      const signedup = Object.values(responseStatusMap).filter(s => s === 'signed_up').length;
      const responded = interested + booked + signedup + Object.values(responseStatusMap).filter(s => s === 'not_interested').length;
      const rate = sentCount > 0 ? Math.round((responded / sentCount) * 100) : 0;
      const followups = getFollowUpsDueCount();

      document.getElementById('dash-sent').textContent = sentCount;
      document.getElementById('dash-rate').textContent = rate + '%';
      document.getElementById('dash-interested').textContent = interested;
      document.getElementById('dash-booked').textContent = booked;
      document.getElementById('dash-signedup').textContent = signedup;
      document.getElementById('dash-followup').textContent = followups;
    }

    // ── CSV Export ──
    function exportCSV() {
      const headers = ['Name','Trade','City','Phone','Display Phone','First Name','Website','Sent','Sent At','Response Status','Follow-up Date','Conversation Notes','Custom Message'];
      const rows = contacts.map(c => {
        const isSent = sentMap[c.phone] || false;
        return [
          c.name,
          c.trade,
          c.city,
          c.phone,
          c.dp,
          c.fn,
          c.web,
          isSent ? 'Yes' : 'No',
          isSent ? (new Date()).toISOString().split('T')[0] : '',
          responseStatusMap[c.phone] ? STATUS_LABELS[responseStatusMap[c.phone]] || responseStatusMap[c.phone] : 'No reply',
          followUpDateMap[c.phone] || '',
          conversationNotesMap[c.phone] || '',
          customMsgs[c.phone] || ''
        ];
      });

      const escape = (v) => {
        const s = String(v || '');
        if (s.includes(',') || s.includes('"') || s.includes('\n')) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      };

      let csv = headers.map(escape).join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(escape).join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `ringvox-outreach-${today}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ── Render ──
    const container = document.getElementById('contacts-container');

    function renderContacts() {
      container.innerHTML = '';
      let filtered = [...contacts];

      // Trade filter
      if (currentFilter === 'followup') {
        filtered = filtered.filter(c => isFollowUpDue(c.phone));
      } else if (currentFilter !== 'all') {
        filtered = filtered.filter(c => c.trade === currentFilter);
      }

      // Search filter
      if (searchTerm) {
        const q = searchTerm.toLowerCase();
        filtered = filtered.filter(c =>
          c.name.toLowerCase().includes(q) ||
          c.city.toLowerCase().includes(q) ||
          c.dp.includes(q) ||
          (c.fn && c.fn.toLowerCase().includes(q))
        );
      }
      document.getElementById('total-shown').textContent = filtered.length;

      let currentCity = '';
      filtered.forEach(contact => {
        if (contact.city !== currentCity) {
          currentCity = contact.city;
          const cityContacts = filtered.filter(c => c.city === currentCity);
          const count = cityContacts.length;
          const citySent = cityContacts.filter(c => sentMap[c.phone]).length;
          const pct = count > 0 ? Math.round((citySent / count) * 100) : 0;
          const h = document.createElement('div');
          h.className = 'batch-header';
          h.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg> ${currentCity} (${count})
          <div class="batch-progress">
            <span>${citySent}/${count} sent</span>
            <div class="batch-progress-bar"><div class="batch-progress-fill" style="width:${pct}%"></div></div>
          </div>`;
          container.appendChild(h);
        }

        const isSent = sentMap[contact.phone] || false;
        const hasCustom = !!customMsgs[contact.phone];
        const status = responseStatusMap[contact.phone] || '';
        const followDate = followUpDateMap[contact.phone] || '';
        const cNotes = conversationNotesMap[contact.phone] || '';
        const followDue = isFollowUpDue(contact.phone);
        let webHost = '';
        try { webHost = contact.web ? new URL(contact.web).hostname.replace('www.','') : ''; } catch(e) {}

        const showReplyTemplates = status === 'interested' || status === 'call_booked' || status === 'signed_up';

        const div = document.createElement('div');
        div.className = 'contact' + (isSent ? ' sent' : '');
        div.dataset.phone = contact.phone;
        div.innerHTML = `
          <div class="contact-row">
            <input type="checkbox" class="sent-check" data-phone="${contact.phone}" ${isSent ? 'checked' : ''}>
            <div class="contact-info">
              <div class="contact-name">
                <span class="trade-badge trade-${contact.trade}">${contact.trade}</span>
                ${contact.fn ? `<strong>${contact.fn}</strong> &mdash; ` : ''}${getBusinessName(contact) || contact.name}
                ${status ? `<span class="status-pill status-${status}">${STATUS_LABELS[status] || status}</span>` : ''}
                ${followDue ? `<span class="followup-badge">Follow up!</span>` : ''}
              </div>
              <div class="contact-details">
                ${contact.city} &middot; ${contact.dp}${webHost ? ` &middot; <a href="${contact.web}" target="_blank" title="${contact.web}">${webHost}</a>` : ''}${followDate ? ` &middot; Follow-up: ${followDate}` : ''}
              </div>
            </div>
            <div class="contact-actions">
              <button class="edit-btn${hasCustom || status || followDate || cNotes ? ' active' : ''}" data-phone="${contact.phone}" title="Edit message">&#9998;</button>
              <a href="${waLink(contact)}" target="_blank" class="whatsapp-btn" data-phone="${contact.phone}">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                Send
              </a>
            </div>
          </div>
          <div class="edit-panel" id="panel-${contact.phone}">
            <div class="edit-panel-controls">
              <div style="display:flex;align-items:center;gap:6px;">
                <label>Status:</label>
                <select class="response-select" data-phone="${contact.phone}">
                  <option value=""${!status ? ' selected' : ''}>No reply</option>
                  <option value="interested"${status === 'interested' ? ' selected' : ''}>Interested</option>
                  <option value="call_booked"${status === 'call_booked' ? ' selected' : ''}>Call booked</option>
                  <option value="not_interested"${status === 'not_interested' ? ' selected' : ''}>Not interested</option>
                  <option value="signed_up"${status === 'signed_up' ? ' selected' : ''}>Signed up</option>
                </select>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <label>Follow-up:</label>
                <input type="date" class="followup-input" data-phone="${contact.phone}" value="${followDate}">
              </div>
              ${showReplyTemplates ? `<button class="reply-templates-btn" data-phone="${contact.phone}">Reply Templates</button>` : ''}
            </div>
            ${showReplyTemplates ? `
            <div class="reply-templates-panel" id="replies-${contact.phone}">
              ${replyTemplates.map((t, i) => `
                <div class="reply-template-item">
                  <div>
                    <div class="reply-template-label">${t.label}</div>
                    <div class="reply-template-text">${t.text}</div>
                  </div>
                  <button class="reply-copy-btn" data-template-idx="${i}">Copy</button>
                </div>
              `).join('')}
            </div>` : ''}
            <div class="message-editor">
              <div class="wa-format-bar">
                <button class="fmt-bold" data-wrap="*" title="Bold *text*">B</button>
                <button class="fmt-italic" data-wrap="_" title="Italic _text_">I</button>
                <button class="fmt-strike" data-wrap="~" title="Strikethrough ~text~">S</button>
                <button class="fmt-mono" data-wrap="\`\`\`" title="Monospace \`\`\`text\`\`\`">&lt;/&gt;</button>
                <span class="wa-format-hint">Select text then click to format</span>
              </div>
              <textarea data-phone="${contact.phone}" data-type="message">${getMsg(contact)}</textarea>
              <div class="editor-actions">
                <small class="${hasCustom ? 'custom' : ''}">${hasCustom ? 'Custom message' : 'Default template'}</small>
                <button class="reset-msg-btn" data-phone="${contact.phone}">Reset to default</button>
              </div>
            </div>
            <div class="notes-section">
              <label>Conversation Notes</label>
              <textarea class="notes-textarea" data-phone="${contact.phone}" data-type="notes" placeholder="Add notes about your conversation...">${cNotes}</textarea>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
      updateCounter();
      updateDashboard();
    }

    // ── Events ──
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderContacts();
      });
    });

    document.getElementById('search').addEventListener('input', function() {
      searchTerm = this.value;
      renderContacts();
    });

    // Checkbox change (sent toggle)
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('sent-check')) {
        const phone = e.target.dataset.phone;
        e.target.closest('.contact').classList.toggle('sent', e.target.checked);
        saveToSupabase(phone, { sent: e.target.checked });
        updateCounter();
        updateDashboard();
      }
      // Response status change
      if (e.target.classList.contains('response-select')) {
        const phone = e.target.dataset.phone;
        const val = e.target.value;
        saveToSupabase(phone, { response_status: val });
        renderContacts();
      }
      // Follow-up date change
      if (e.target.classList.contains('followup-input')) {
        const phone = e.target.dataset.phone;
        const val = e.target.value;
        saveToSupabase(phone, { follow_up_date: val });
        updateDashboard();
        // Update follow-up badge and details line without full re-render
        const contactEl = e.target.closest('.contact');
        const nameEl = contactEl.querySelector('.contact-name');
        const existingBadge = nameEl.querySelector('.followup-badge');
        if (existingBadge) existingBadge.remove();
        if (val && isFollowUpDue(phone)) {
          const badge = document.createElement('span');
          badge.className = 'followup-badge';
          badge.textContent = 'Follow up!';
          nameEl.appendChild(badge);
        }
      }
    });

    document.addEventListener('click', function(e) {
      // WhatsApp send button
      const btn = e.target.closest('.whatsapp-btn');
      if (btn) {
        const phone = btn.dataset.phone;
        const row = btn.closest('.contact');
        row.classList.add('sent');
        row.querySelector('.sent-check').checked = true;
        saveToSupabase(phone, { sent: true });
        updateCounter();
        updateDashboard();
      }
      // Edit button toggle
      if (e.target.classList.contains('edit-btn')) {
        const phone = e.target.dataset.phone;
        const panel = document.getElementById('panel-' + phone);
        panel.classList.toggle('open');
        const hasData = !!customMsgs[phone] || !!responseStatusMap[phone] || !!followUpDateMap[phone] || !!conversationNotesMap[phone];
        e.target.classList.toggle('active', panel.classList.contains('open') || hasData);
      }
      // Reset message button
      if (e.target.classList.contains('reset-msg-btn')) {
        const phone = e.target.dataset.phone;
        const contact = contacts.find(c => c.phone === phone);
        const msg = getDefaultMessage(contact);
        const panel = document.getElementById('panel-' + phone);
        panel.querySelector('textarea[data-type="message"]').value = msg;
        delete customMsgs[phone];
        saveToSupabase(phone, { notes: '' });
        const row = panel.closest('.contact');
        const waBtn = row.querySelector('.whatsapp-btn');
        waBtn.href = `https://wa.me/${phone.replace(/[a-z]$/i,'')}?text=${encodeURIComponent(msg)}`;
        panel.querySelector('.editor-actions small').textContent = 'Default template';
        panel.querySelector('.editor-actions small').className = '';
        const hasData = !!responseStatusMap[phone] || !!followUpDateMap[phone] || !!conversationNotesMap[phone];
        row.querySelector('.edit-btn').classList.toggle('active', hasData);
      }
      // WhatsApp format buttons
      if (e.target.dataset.wrap) {
        const wrap = e.target.dataset.wrap;
        const editor = e.target.closest('.message-editor');
        const ta = editor.querySelector('textarea[data-type="message"]');
        const start = ta.selectionStart;
        const end = ta.selectionEnd;
        if (start === end) return; // nothing selected
        const before = ta.value.substring(0, start);
        const selected = ta.value.substring(start, end);
        const after = ta.value.substring(end);
        ta.value = before + wrap + selected + wrap + after;
        // Re-select the wrapped text (including markers)
        ta.selectionStart = start;
        ta.selectionEnd = end + wrap.length * 2;
        ta.focus();
        // Trigger save
        ta.dispatchEvent(new Event('input', { bubbles: true }));
      }
      // Reply templates button
      if (e.target.classList.contains('reply-templates-btn')) {
        const phone = e.target.dataset.phone;
        const repliesPanel = document.getElementById('replies-' + phone);
        if (repliesPanel) repliesPanel.classList.toggle('open');
      }
      // Reply copy button
      if (e.target.classList.contains('reply-copy-btn')) {
        const idx = parseInt(e.target.dataset.templateIdx);
        const template = replyTemplates[idx];
        if (template) {
          navigator.clipboard.writeText(template.text).then(() => {
            e.target.textContent = 'Copied!';
            e.target.classList.add('copied');
            setTimeout(() => {
              e.target.textContent = 'Copy';
              e.target.classList.remove('copied');
            }, 2000);
          });
        }
      }
    });

    // Textarea input (message editor + conversation notes)
    document.addEventListener('input', function(e) {
      if (e.target.tagName === 'TEXTAREA' && e.target.dataset.phone) {
        const phone = e.target.dataset.phone;
        const type = e.target.dataset.type;

        if (type === 'message') {
          // Message editor
          const contact = contacts.find(c => c.phone === phone);
          const def = getDefaultMessage(contact);
          const val = e.target.value;
          const isCustom = val !== def;

          if (isCustom) customMsgs[phone] = val; else delete customMsgs[phone];
          clearTimeout(e.target._t);
          e.target._t = setTimeout(() => saveToSupabase(phone, { notes: isCustom ? val : '' }), 800);

          const row = e.target.closest('.contact');
          row.querySelector('.whatsapp-btn').href = `https://wa.me/${phone.replace(/[a-z]$/i,'')}?text=${encodeURIComponent(val)}`;
          const sm = row.querySelector('.editor-actions small');
          sm.textContent = isCustom ? 'Custom message' : 'Default template';
          sm.className = isCustom ? 'custom' : '';
        } else if (type === 'notes') {
          // Conversation notes
          const val = e.target.value;
          clearTimeout(e.target._t);
          e.target._t = setTimeout(() => saveToSupabase(phone, { conversation_notes: val }), 800);
        }
      }
    });

    function resetAll() {
      if (!confirm('Reset all sent markers, custom messages, statuses, follow-ups, and notes?')) return;
      sentMap = {}; customMsgs = {}; responseStatusMap = {}; followUpDateMap = {}; conversationNotesMap = {};
      localStorage.removeItem('wa-sent');
      localStorage.removeItem('wa-msgs');
      localStorage.removeItem('wa-status');
      localStorage.removeItem('wa-followup');
      localStorage.removeItem('wa-notes');
      sbFetch('outreach_contacts', { method: 'DELETE', headers: { 'Prefer': '' } }).catch(() => {});
      renderContacts();
    }

    // ── Init (only after auth) ──
    async function initApp() {
      await loadFromSupabase();
      renderContacts();
    }

    // ── Password Gate ──
    const ACCESS_HASH = 'b3b39830e6dfa2c385dbf6b059533641645cd9d13aaf02d2dced361e83957089';

    async function sha256(text) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function checkAuth(code) {
      const hash = await sha256(code);
      return hash === ACCESS_HASH;
    }

    // Check if already authenticated
    (async function() {
      const saved = localStorage.getItem('rv-auth');
      if (saved && await checkAuth(saved)) {
        document.getElementById('login-gate').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initApp();
      }
    })();

    // Login button
    document.getElementById('login-btn').addEventListener('click', async () => {
      const pwd = document.getElementById('login-password').value;
      if (await checkAuth(pwd)) {
        localStorage.setItem('rv-auth', pwd);
        document.getElementById('login-gate').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initApp();
      } else {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-password').value = '';
        document.getElementById('login-password').focus();
      }
    });

    // Enter key on password field
    document.getElementById('login-password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('login-btn').click();
    });
    </script>

    </div><!-- /app-content -->
</body>
</html>
